/**
 * @obinexuscomputing/nexus-search v1.0.0
 * High-performance search indexing and query system
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("idb")):"function"==typeof define&&define.amd?define(["exports","idb"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NexusSearch={},e.idb)}(this,(function(e,t){"use strict";class r extends Error{constructor(e){super(e),this.name="SearchError"}}class s extends Error{constructor(e){super(e),this.name="IndexError"}}class a extends Error{constructor(e){super(e),this.name="ValidationError"}}class i extends Error{constructor(e){super(e),this.name="StorageError"}}function n(){return{totalResults:0,searchTime:0,indexSize:0,queryComplexity:0}}class o{constructor(){this.dataMap=new Map}mapData(e,t){this.dataMap.has(e)||this.dataMap.set(e,new Set),this.dataMap.get(e).add(t)}getDocuments(e){return this.dataMap.get(e)||new Set}getAllKeys(){return Array.from(this.dataMap.keys())}clear(){this.dataMap.clear()}}class c{constructor(){this.children=new Map,this.isEndOfWord=!1,this.data=new Set}}class h{constructor(){this.root=new c}insert(e,t){let r=this.root;for(const t of e.toLowerCase())r.children.has(t)||r.children.set(t,new c),r=r.children.get(t);r.isEndOfWord=!0,r.data.add(t)}search(e,t=10){const r=new Set;let s=this.root;for(const t of e.toLowerCase()){if(!s.children.has(t))return r;s=s.children.get(t)}return this.collectIds(s,r,t),r}collectIds(e,t,r){if(e.isEndOfWord)for(const s of e.data){if(t.size>=r)return;t.add(s)}for(const s of e.children.values()){if(t.size>=r)return;this.collectIds(s,t,r)}}fuzzySearch(e,t=2){const r=new Set;return this.fuzzySearchHelper(e.toLowerCase(),this.root,"",t,r),r}fuzzySearchHelper(e,t,r,s,a){if(!(s<0)){if(t.isEndOfWord){this.levenshteinDistance(e,r)<=s&&t.data.forEach((e=>a.add(e)))}for(const[i,n]of t.children)this.fuzzySearchHelper(e,n,r+i,s,a)}}levenshteinDistance(e,t){const r=Array(e.length+1).fill(0).map((()=>Array(t.length+1).fill(0)));for(let t=0;t<=e.length;t++)r[t][0]=t;for(let e=0;e<=t.length;e++)r[0][e]=e;for(let s=1;s<=e.length;s++)for(let a=1;a<=t.length;a++)r[s][a]=Math.min(r[s-1][a]+1,r[s][a-1]+1,r[s-1][a-1]+(e[s-1]!==t[a-1]?1:0));return r[e.length][t.length]}}class d{constructor(){this.dataMapper=new o,this.trieSearch=new h}indexDocument(e,t,r){r.forEach((r=>{const s=e[r];if("string"==typeof s){s.split(/\s+/).forEach((e=>{this.trieSearch.insert(e,t),this.dataMapper.mapData(e.toLowerCase(),t)}))}}))}search(e,t={}){const{fuzzy:r=!1,maxResults:s=10}=t,a=r?this.trieSearch.fuzzySearch(e):this.trieSearch.search(e,s);return Array.from(a).map((t=>({item:t,score:this.calculateScore(t,e),matches:[e]}))).slice(0,s)}calculateScore(e,t){return this.dataMapper.getDocuments(t.toLowerCase()).has(e)?1:.5}}function l(e,t){const r={};return t.forEach((t=>{const s=f(e,t);void 0!==s&&(r[t]=u(s))})),r}function u(e){return"string"==typeof e?e.toLowerCase().trim():Array.isArray(e)?e.map((e=>u(e))).join(" "):"object"==typeof e&&null!==e?Object.values(e).map((e=>u(e))).join(" "):String(e)}function f(e,t){return t.split(".").reduce(((e,t)=>e&&void 0!==e[t]?e[t]:void 0),e)}class m{constructor(e){this.config=e,this.indexMapper=new d,this.documents=new Map}async addDocuments(e){e.forEach(((e,t)=>{const r=this.generateDocumentId(t);this.documents.set(r,e);const s=l(e,this.config.fields);this.indexMapper.indexDocument(s,r,this.config.fields)}))}async search(e,t){return this.indexMapper.search(e,{fuzzy:t.fuzzy,maxResults:t.maxResults}).map((e=>({item:this.documents.get(e.item),score:e.score,matches:e.matches})))}exportIndex(){return{documents:Array.from(this.documents.entries()),config:this.config}}importIndex(e){this.documents=new Map(e.documents),this.config=e.config}clear(){this.documents.clear(),this.indexMapper=new d}generateDocumentId(e){return`${this.config.name}-${e}-${Date.now()}`}}class p{constructor(){this.STOP_WORDS=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","were","will","with"])}process(e){const t=this.tokenize(e),r=this.processTokens(t);return this.optimizeQuery(r)}tokenize(e){return e.toLowerCase().split(/\s+/).filter((e=>e.length>0)).map((e=>this.classifyToken(e)))}classifyToken(e){return e.startsWith("+")||e.startsWith("-")?{type:"operator",value:e}:e.includes(":")?{type:"modifier",value:e}:{type:"term",value:e}}processTokens(e){return e.filter((e=>"term"!==e.type||!this.STOP_WORDS.has(e.value))).map((e=>this.normalizeToken(e)))}normalizeToken(e){if("term"===e.type){let t=e.value;return t.endsWith("ing")&&(t=t.slice(0,-3)),t.endsWith("s")&&(t=t.slice(0,-1)),{...e,value:t}}return e}optimizeQuery(e){return e.map((e=>e.value)).join(" ")}}class y{constructor(){this.db=null,this.DB_NAME="nexus_search_db",this.DB_VERSION=1}async initialize(){try{this.db=await t.openDB(this.DB_NAME,this.DB_VERSION,{upgrade(e){e.objectStoreNames.contains("searchIndices")||e.createObjectStore("searchIndices",{keyPath:"id"}),e.objectStoreNames.contains("metadata")||e.createObjectStore("metadata",{keyPath:"id"})}})}catch(e){throw console.error("Failed to initialize IndexedDB:",e),new Error("Storage initialization failed")}}async storeIndex(e,t){if(!this.db)throw new Error("Database not initialized");const r={id:e,data:t,timestamp:Date.now()};await this.db.put("searchIndices",r)}async getIndex(e){if(!this.db)throw new Error("Database not initialized");const t=await this.db.get("searchIndices",e);return t?.data||null}async updateMetadata(e){if(!this.db)throw new Error("Database not initialized");const t={config:e,lastUpdated:Date.now()};await this.db.put("metadata",t,"config")}async clearIndices(){if(!this.db)throw new Error("Database not initialized");await this.db.clear("searchIndices")}}class g{constructor(e=1e3,t=5){this.cache=new Map,this.maxSize=e,this.ttl=60*t*1e3}set(e,t){this.cache.size>=this.maxSize&&this.evictOldest(),this.cache.set(e,{data:t,timestamp:Date.now()})}get(e){const t=this.cache.get(e);return t?this.isExpired(t.timestamp)?(this.cache.delete(e),null):t.data:null}isExpired(e){return Date.now()-e>this.ttl}evictOldest(){let e=null,t=1/0;for(const[r,s]of this.cache.entries())s.timestamp<t&&(t=s.timestamp,e=r);e&&this.cache.delete(e)}clear(){this.cache.clear()}}function w(e){if(e.maxResults&&e.maxResults<1)throw new Error("maxResults must be greater than 0");if(e.threshold&&(e.threshold<0||e.threshold>1))throw new Error("threshold must be between 0 and 1");if(e.fields&&!Array.isArray(e.fields))throw new Error("fields must be an array")}e.DEFAULT_INDEX_OPTIONS={caseSensitive:!1,stemming:!0,stopWords:["the","a","an","and","or","but"],minWordLength:2,maxWordLength:50,fuzzyThreshold:.8},e.DEFAULT_SEARCH_OPTIONS={fuzzy:!1,maxResults:10,threshold:.5,fields:[],sortBy:"score",sortOrder:"desc",page:1,pageSize:10},e.IndexError=s,e.IndexManager=m,e.QueryProcessor=p,e.SearchEngine=class{constructor(e){this.config=e,this.indexManager=new m(e),this.queryProcessor=new p,this.storage=new y,this.cache=new g}async initialize(){try{await this.storage.initialize(),await this.loadIndexes()}catch(e){throw new Error(`Failed to initialize search engine: ${e}`)}}async addDocuments(e){try{await this.indexManager.addDocuments(e),await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())}catch(e){throw new Error(`Failed to add documents: ${e}`)}}async search(e,t={}){w(t);const r=this.generateCacheKey(e,t),s=this.cache.get(r);if(s)return s;const a=this.queryProcessor.process(e),i=await this.indexManager.search(a,t);return this.cache.set(r,i),i}async loadIndexes(){const e=await this.storage.getIndex(this.config.name);e&&this.indexManager.importIndex(e)}generateCacheKey(e,t){return`${e}-${JSON.stringify(t)}`}async clearIndex(){await this.storage.clearIndices(),this.indexManager.clear(),this.cache.clear()}},e.SearchError=r,e.StorageError=i,e.ValidationError=a,e.createSearchContext=function(e,t={}){return{query:e,options:t,startTime:Date.now(),results:[],stats:{totalResults:0,searchTime:0,indexSize:0,queryComplexity:0}}},e.createSearchStats=n,e.createSearchableFields=l,e.createTokenInfo=function(e,t,r){return{value:e,type:t,position:r,length:e.length}},e.isIndexConfig=function(e){return e&&"string"==typeof e.name&&"number"==typeof e.version&&Array.isArray(e.fields)},e.isSearchOptions=function(e){return e&&(void 0===e.fuzzy||"boolean"==typeof e.fuzzy)&&(void 0===e.maxResults||"number"==typeof e.maxResults)},e.isSearchResult=function(e){return e&&"item"in e&&"number"==typeof e.score&&Array.isArray(e.matches)},e.optimizeIndex=function(e){return Array.from(new Set(e.map((e=>JSON.stringify(e))))).map((e=>JSON.parse(e))).sort(((e,t)=>JSON.stringify(e).localeCompare(JSON.stringify(t))))},e.validateDocument=function(e,t){return t.every((t=>void 0!==f(e,t)))},e.validateIndexConfig=function(e){if(!e.name)throw new Error("Index name is required");if(!e.version||"number"!=typeof e.version)throw new Error("Valid version number is required");if(!Array.isArray(e.fields)||0===e.fields.length)throw new Error("At least one field must be specified for indexing")},e.validateSearchOptions=w}));
//# sourceMappingURL=index.js.map
