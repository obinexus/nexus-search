/**
 * @obinexuscomputing/nexus-search v0.1.56
 * A high-performance search indexing and query system that uses a trie data structure and BFS/DFS algorithms for fast full-text search with fuzzy matching.
 * @license ISC
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("idb")):"function"==typeof define&&define.amd?define(["exports","idb"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NexusSearch={},e.idb)}(this,(function(e,t){"use strict";class i{getSize(){return this.cache.size}getStatus(){const e=Array.from(this.cache.values()).map((e=>e.timestamp)),t=Date.now(),i=this.calculateMemoryUsage();return{size:this.cache.size,maxSize:this.maxSize,strategy:this.strategy,ttl:this.ttl,utilization:this.cache.size/this.maxSize,oldestEntryAge:e.length?t-Math.min(...e):null,newestEntryAge:e.length?t-Math.max(...e):null,memoryUsage:{bytes:i,formatted:this.formatBytes(i)}}}calculateMemoryUsage(){let e=0;for(const[t,i]of this.cache.entries())e+=2*t.length,e+=24,e+=this.estimateDataSize(i.data);return e+=8*(3+this.accessOrder.length+3),e}estimateDataSize(e){let t=0;for(const i of e)t+=8,t+=2*i.matches.join("").length,t+=2*JSON.stringify(i.item).length,i.metadata&&(t+=2*JSON.stringify(i.metadata).length);return t}formatBytes(e){const t=["B","KB","MB","GB"];let i=e,s=0;for(;i>=1024&&s<t.length-1;)i/=1024,s++;return`${i.toFixed(2)} ${t[s]}`}constructor(e=1e3,t=5,i="LRU"){this.cache=new Map,this.maxSize=e,this.ttl=60*t*1e3,this.strategy=i,this.accessOrder=[],this.stats={hits:0,misses:0,evictions:0}}set(e,t){this.cache.size>=this.maxSize&&this.evict();const i={data:t,timestamp:Date.now(),lastAccessed:Date.now(),accessCount:1};this.cache.set(e,i),this.updateAccessOrder(e)}get(e){const t=this.cache.get(e);return t?this.isExpired(t.timestamp)?(this.cache.delete(e),this.removeFromAccessOrder(e),this.stats.misses++,null):(t.lastAccessed=Date.now(),t.accessCount++,this.updateAccessOrder(e),this.stats.hits++,t.data):(this.stats.misses++,null)}clear(){this.cache.clear(),this.accessOrder=[],this.stats={hits:0,misses:0,evictions:0}}getStats(){return{...this.stats,size:this.cache.size,maxSize:this.maxSize,hitRate:this.stats.hits/(this.stats.hits+this.stats.misses),strategy:this.strategy}}isExpired(e){return Date.now()-e>this.ttl}evict(){const e="LRU"===this.strategy?this.findLRUKey():this.findMRUKey();e&&(this.cache.delete(e),this.removeFromAccessOrder(e),this.stats.evictions++)}findLRUKey(){return this.accessOrder[0]||null}findMRUKey(){return this.accessOrder[this.accessOrder.length-1]||null}updateAccessOrder(e){this.removeFromAccessOrder(e),"LRU"===this.strategy?this.accessOrder.push(e):this.accessOrder.unshift(e)}removeFromAccessOrder(e){const t=this.accessOrder.indexOf(e);-1!==t&&this.accessOrder.splice(t,1)}setStrategy(e){if(e===this.strategy)return;this.strategy=e;const t=[...this.accessOrder];this.accessOrder=[],t.forEach((e=>this.updateAccessOrder(e)))}prune(){let e=0;for(const[t,i]of this.cache.entries())this.isExpired(i.timestamp)&&(this.cache.delete(t),this.removeFromAccessOrder(t),e++);return e}analyze(){const e=this.stats.hits+this.stats.misses,t=e>0?this.stats.hits/e:0;let i=0;const s=new Map;for(const[e,t]of this.cache.entries())i+=t.accessCount,s.set(e,t.accessCount);return{hitRate:t,averageAccessCount:this.cache.size>0?i/this.cache.size:0,mostAccessedKeys:Array.from(s.entries()).sort(((e,t)=>t[1]-e[1])).slice(0,5).map((([e,t])=>({key:e,count:t})))}}}class s{constructor(e={type:"memory"}){this.db=null,this.memoryStorage=new Map,this.storageType=this.determineStorageType(e)}determineStorageType(e){return"memory"!==e.type&&this.isIndexedDBAvailable()?"indexeddb":"memory"}isIndexedDBAvailable(){try{return"undefined"!=typeof indexedDB&&null!==indexedDB}catch(e){return!1}}async initialize(){if("memory"!==this.storageType)try{this.db=await t.openDB("nexus-search-db",1,{upgrade(e){e.createObjectStore("searchIndices",{keyPath:"id"}).createIndex("timestamp","timestamp");e.createObjectStore("metadata",{keyPath:"id"}).createIndex("lastUpdated","lastUpdated")}})}catch(e){this.storageType="memory",console.warn("Failed to initialize IndexedDB, falling back to memory storage:",e)}}async storeIndex(e,t){var i;if("memory"!==this.storageType)try{await(null===(i=this.db)||void 0===i?void 0:i.put("searchIndices",{id:e,data:t,timestamp:Date.now()}))}catch(i){console.error("Storage error:",i),this.memoryStorage.set(e,t)}else this.memoryStorage.set(e,t)}async getIndex(e){var t;if("memory"===this.storageType)return this.memoryStorage.get(e);try{const i=await(null===(t=this.db)||void 0===t?void 0:t.get("searchIndices",e));return null==i?void 0:i.data}catch(t){return console.error("Retrieval error:",t),this.memoryStorage.get(e)}}async clearIndices(){var e;if("memory"!==this.storageType)try{await(null===(e=this.db)||void 0===e?void 0:e.clear("searchIndices"))}catch(e){console.error("Clear error:",e),this.memoryStorage.clear()}else this.memoryStorage.clear()}async close(){this.db&&(this.db.close(),this.db=null),this.memoryStorage.clear()}}class r{constructor(e,t,i,s=[],r=[]){this.id=e,this.fields=this.normalizeFields(t),this.metadata=this.normalizeMetadata(i),this.versions=s,this.relations=r,this.content=this.normalizeContent(this.fields.content)}document(){return this}normalizeFields(e){return{...e,title:e.title||"",author:e.author||"",tags:Array.isArray(e.tags)?[...e.tags]:[],version:e.version||"1.0"}}normalizeContent(e){return"string"==typeof e?{text:e}:e||{}}normalizeMetadata(e){const t=Date.now();return{indexed:t,lastModified:t,...e}}clone(){return new r(this.id,JSON.parse(JSON.stringify(this.fields)),this.metadata?{...this.metadata}:void 0,this.versions.map((e=>({...e}))),this.relations.map((e=>({...e}))))}update(e){const t={...this.fields},i={...this.metadata,lastModified:Date.now()};return e.fields&&Object.entries(e.fields).forEach((([e,i])=>{void 0!==i&&(t[e]=i)})),e.metadata&&Object.assign(i,e.metadata),new r(this.id,t,i,e.versions||this.versions,e.relations||this.relations)}getField(e){return this.fields[e]}setField(e,t){this.fields[e]=t,this.metadata&&(this.metadata.lastModified=Date.now()),"content"===e&&(this.content=t)}addVersion(e){const t=this.versions.length+1;this.versions.push({...e,version:t}),this.fields.version=String(t),this.metadata&&(this.metadata.lastModified=Date.now())}addRelation(e){this.relations.push(e),this.metadata&&(this.metadata.lastModified=Date.now())}toObject(){return{id:this.id,fields:{...this.fields},metadata:this.metadata?{...this.metadata}:void 0,versions:this.versions.map((e=>({...e}))),relations:this.relations.map((e=>({...e})))}}toJSON(){return JSON.stringify(this.toObject())}toString(){return`IndexedDocument(${this.id})`}static create(e){return new r(e.id,e.fields,e.metadata,e.versions,e.relations)}static fromObject(e){return r.create({id:e.id,fields:e.fields,metadata:e.metadata,versions:e.versions||[],relations:e.relations||[]})}static fromRawData(e,t,i){return new r(e,{title:"",content:"string"==typeof t?{text:t}:t,author:"",tags:[],version:"1.0"},i)}}class n{constructor(){this.dataMap=new Map}mapData(e,t){this.dataMap.has(e)||this.dataMap.set(e,new Set),this.dataMap.get(e).add(t)}getDocuments(e){return this.dataMap.get(e)||new Set}getDocumentById(e){const t=new Set;return this.dataMap.forEach((i=>{i.has(e)&&t.add(e)})),t}getAllKeys(){return Array.from(this.dataMap.keys())}removeDocument(e){this.dataMap.forEach((t=>{t.delete(e)}))}removeKey(e){this.dataMap.delete(e)}exportState(){const e={};return this.dataMap.forEach(((t,i)=>{e[i]=Array.from(t)})),e}importState(e){this.dataMap.clear(),Object.entries(e).forEach((([e,t])=>{this.dataMap.set(e,new Set(t))}))}clear(){this.dataMap.clear()}}class o{constructor(e=0){this.children=new Map,this.isEndOfWord=!1,this.documentRefs=new Set,this.weight=0,this.frequency=0,this.lastAccessed=Date.now(),this.prefixCount=0,this.depth=e}addChild(e){const t=new o(this.depth+1);return this.children.set(e,t),t}getChild(e){return this.children.get(e)}hasChild(e){return this.children.has(e)}incrementWeight(e=1){this.weight+=e,this.frequency++,this.lastAccessed=Date.now()}decrementWeight(e=1){this.weight=Math.max(0,this.weight-e),this.frequency=Math.max(0,this.frequency-1)}clearChildren(){this.children.clear(),this.documentRefs.clear(),this.weight=0,this.frequency=0}shouldPrune(){return 0===this.children.size&&0===this.documentRefs.size&&0===this.weight&&0===this.frequency}getScore(){const e=Math.exp(-(Date.now()-this.lastAccessed)/864e5);return this.weight*this.frequency*e/(this.depth+1)}}class a{constructor(e=50){this.root=new o,this.documents=new Map,this.documentLinks=new Map,this.totalDocuments=0,this.maxWordLength=e}addDocument(e){e.id&&(this.documents.set(e.id,e),this.totalDocuments++,Object.values(e.fields).forEach((t=>{"string"==typeof t?this.indexText(t,e.id):Array.isArray(t)&&t.forEach((t=>{"string"==typeof t&&this.indexText(t,e.id)}))})))}indexText(e,t){const i=this.tokenize(e);new Set(i).forEach((e=>{e.length<=this.maxWordLength&&this.insertWord(e,t)}))}insertWord(e,t){let i=this.root;i.prefixCount++;for(const t of e)i=i.hasChild(t)?i.getChild(t):i.addChild(t),i.prefixCount++;i.isEndOfWord=!0,i.documentRefs.add(t),i.incrementWeight()}searchWord(e){return this.search(e)}search(e,t={}){const{fuzzy:i=!1,maxDistance:s=2,prefixMatch:r=!1,maxResults:n=10,minScore:o=.1,caseSensitive:a=!1}=t,c=this.tokenize(e,a),d=new Map;return c.forEach((e=>{let t=[];t=i?this.fuzzySearch(e,s):r?this.prefixSearch(e):this.exactSearch(e),t.forEach((e=>{const t=d.get(e.docId);(!t||t.score<e.score)&&d.set(e.docId,e)}))})),Array.from(d.values()).filter((e=>e.score>=o)).sort(((e,t)=>t.score-e.score)).slice(0,n)}exactSearch(e){const t=[];let i=this.root;for(const s of e){if(!i.hasChild(s))return t;i=i.getChild(s)}return i.isEndOfWord&&i.documentRefs.forEach((s=>{t.push({docId:s,score:this.calculateScore(i,e),term:e,id:"",document:this.documents.get(s),item:void 0,matches:[]})})),t}prefixSearch(e){const t=[];let i=this.root;for(const s of e){if(!i.hasChild(s))return t;i=i.getChild(s)}return this.collectWords(i,e,t),t}serializeState(){return{trie:this.serializeTrie(this.root),documents:Array.from(this.documents.entries()),documentLinks:Array.from(this.documentLinks.entries()),totalDocuments:this.totalDocuments,maxWordLength:this.maxWordLength}}deserializeState(e){this.root=this.deserializeTrie(e.trie),this.documents=new Map(e.documents),this.documentLinks=new Map(e.documentLinks),this.totalDocuments=e.totalDocuments,this.maxWordLength=e.maxWordLength}serializeTrie(e){const t={prefixCount:e.prefixCount,isEndOfWord:e.isEndOfWord,documentRefs:Array.from(e.documentRefs),children:{}};return e.children.forEach(((e,i)=>{t.children[i]=this.serializeTrie(e)})),t}addData(e,t,i){e&&t&&this.addDocument({id:e,fields:{content:t,title:i.fields.title||"",author:i.fields.author||"",tags:i.fields.tags||[],version:i.fields.version||""},metadata:i.metadata,versions:i.versions||[],links:i.links||[],ranks:[],document:function(){throw new Error("Function not implemented.")},relations:[]})}deserializeTrie(e){const t=new o;t.prefixCount=e.prefixCount,t.isEndOfWord=e.isEndOfWord,t.documentRefs=new Set(e.documentRefs);for(const i in e.children)t.children.set(i,this.deserializeTrie(e.children[i]));return t}collectWords(e,t,i){e.isEndOfWord&&e.documentRefs.forEach((s=>{i.push({docId:s,score:this.calculateScore(e,t),term:t,id:"",document:this.documents.get(s),item:void 0,matches:[]})})),e.children.forEach(((e,s)=>{this.collectWords(e,t+s,i)}))}fuzzySearch(e,t){const i=[],s={word:e,maxDistance:t,results:i};return this.fuzzySearchRecursive(this.root,"",0,0,s),i}fuzzySearchRecursive(e,t,i,s,r){if(!(i>r.maxDistance)){if(e.isEndOfWord){const i=this.calculateLevenshteinDistance(r.word,t);i<=r.maxDistance&&e.documentRefs.forEach((s=>r.results.push({docId:s,score:this.calculateFuzzyScore(e,t,i),term:t,distance:i,id:"",document:this.documents.get(s),item:void 0,matches:[]})))}e.children.forEach(((n,o)=>{const a=o!==r.word[s]?1:0;this.fuzzySearchRecursive(n,t+o,i+a,s+1,r),this.fuzzySearchRecursive(n,t+o,i+1,s,r),s<r.word.length&&this.fuzzySearchRecursive(e,t,i+1,s+1,r)}))}}calculateScore(e,t){const i=e.frequency/this.totalDocuments*Math.log(this.totalDocuments/e.documentRefs.size),s=1/(e.depth+1),r=1/Math.sqrt(t.length);return e.getScore()*i*s*r}calculateFuzzyScore(e,t,i){return this.calculateScore(e,t)*Math.exp(-i)}calculateLevenshteinDistance(e,t){const i=Array(e.length+1).fill(0).map((()=>Array(t.length+1).fill(0)));for(let t=0;t<=e.length;t++)i[t][0]=t;for(let e=0;e<=t.length;e++)i[0][e]=e;for(let s=1;s<=e.length;s++)for(let r=1;r<=t.length;r++){const n=e[s-1]!==t[r-1]?1:0;i[s][r]=Math.min(i[s-1][r]+1,i[s][r-1]+1,i[s-1][r-1]+n)}return i[e.length][t.length]}tokenize(e,t=!1){return(t?e:e.toLowerCase()).split(/[\s,.!?;:'"()\[\]{}\/\\]+/).filter((e=>e.length>0))}removeDocument(e){this.removeDocumentRefs(this.root,e),this.documents.delete(e),this.documentLinks.delete(e),this.totalDocuments=Math.max(0,this.totalDocuments-1),this.pruneEmptyNodes(this.root)}removeDocumentRefs(e,t){e.documentRefs.has(t)&&(e.documentRefs.delete(t),e.decrementWeight(),e.prefixCount=Math.max(0,e.prefixCount-1)),e.children.forEach((e=>{this.removeDocumentRefs(e,t)}))}pruneEmptyNodes(e){return e.children.forEach(((t,i)=>{this.pruneEmptyNodes(t)&&e.children.delete(i)})),e.shouldPrune()}getSuggestions(e,t=5){let i=this.root;for(const t of e){if(!i.hasChild(t))return[];i=i.getChild(t)}const s=[];return this.collectSuggestions(i,e,s),s.sort(((e,t)=>t.score-e.score)).slice(0,t).map((e=>e.word))}collectSuggestions(e,t,i){e.isEndOfWord&&i.push({word:t,score:e.getScore()}),e.children.forEach(((e,s)=>{this.collectSuggestions(e,t+s,i)}))}clear(){this.root=new o,this.documents.clear(),this.documentLinks.clear(),this.totalDocuments=0}}class c{constructor(e){this.dataMapper=new n,(null==e?void 0:e.dataMap)&&this.dataMapper.importState(e.dataMap),this.trieSearch=new a,this.documents=new Map,this.documentScores=new Map}indexDocument(e,t,i){try{e.content&&this.documents.set(t,{id:t,fields:e.content,metadata:e.metadata}),i.forEach((i=>{const s=e.content[i];if(null!=s){const e=this.normalizeValue(s);this.tokenizeText(e).forEach((e=>{e&&(this.trieSearch.addDocument({id:t,fields:{[i]:e,title:"",content:{},author:"",tags:[],version:""},versions:[],relations:[],metadata:{},document:()=>{const e=this.documents.get(t);if(!e)throw new Error(`Document with id ${t} not found`);return e}}),this.dataMapper.mapData(e.toLowerCase(),t))}))}}))}catch(e){throw console.error(`Error indexing document ${t}:`,e),new Error(`Failed to index document: ${e}`)}}search(e,t={}){try{const{fuzzy:i=!1,maxResults:s=10}=t,r=this.tokenizeText(e);return this.documentScores.clear(),r.forEach((e=>{if(!e)return;(i?this.trieSearch.fuzzySearch(e,2):this.trieSearch.searchWord(e)).forEach((t=>{const i=t.docId,s=this.documentScores.get(i)||{score:0,matches:new Set};s.score+=this.calculateScore(i,e),s.matches.add(e),this.documentScores.set(i,s)}))})),Array.from(this.documentScores.entries()).map((([t,{score:i,matches:s}])=>{var n;return{id:t,docId:t,document:this.documents.get(t),item:t,term:e,score:i/r.length,matches:Array.from(s),metadata:null===(n=this.documents.get(t))||void 0===n?void 0:n.metadata}})).sort(((e,t)=>t.score-e.score)).slice(0,s)}catch(e){return console.error("Search error:",e),[]}}normalizeValue(e){return"string"==typeof e?e:Array.isArray(e)?e.map((e=>this.normalizeValue(e))).join(" "):"object"==typeof e&&null!==e?Object.values(e).map((e=>this.normalizeValue(e))).join(" "):String(e)}tokenizeText(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter((e=>e.length>0))}calculateScore(e,t){return(this.dataMapper.getDocuments(t.toLowerCase()).has(e)?1:.5)*(1+this.calculateTermFrequency(e,t))}calculateTermFrequency(e,t){const i=this.documents.get(e);if(!i)return 0;const s=Object.values(i.fields).join(" ").toLowerCase(),r=new RegExp(t,"gi"),n=s.match(r);return n?n.length:0}removeDocument(e){this.trieSearch.removeDocument(e),this.dataMapper.removeDocument(e),this.documents.delete(e),this.documentScores.delete(e)}addDocument(e,t,i){this.indexDocument(e,t,i)}updateDocument(e,t,i){this.removeDocument(t),this.indexDocument(e,t,i)}getDocumentById(e){return this.documents.get(e)}getAllDocuments(){return new Map(this.documents)}exportState(){return{trie:this.trieSearch.serializeState(),dataMap:this.dataMapper.exportState(),documents:Array.from(this.documents.entries())}}importState(e){if(!e||!e.trie||!e.dataMap)throw new Error("Invalid index state");this.trieSearch=new a,this.trieSearch.deserializeState(e.trie);const t=new n;t.importState(e.dataMap),this.dataMapper=t,e.documents&&(this.documents=new Map(e.documents))}clear(){this.trieSearch=new a;const e=new n;this.dataMapper=e,this.documents.clear(),this.documentScores.clear()}}function d(e,t){const{caseSensitive:i=!1,wholeWord:s=!1}=t;if(e instanceof RegExp){const t=`${i?"":"i"}${e.global?"g":""}`;return new RegExp(e.source,t)}let r=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");return s&&(r=`\\b${r}\\b`),new RegExp(r,i?"g":"ig")}function h(e,t,i){const s=e.score||1,r=t.match(i)||[];return s*r.length*(r.reduce(((e,t)=>e+t.length),0)/t.length)*(1/(e.depth||1))}function l(e,t){const i=[];let s;const r=new RegExp(t.source,t.flags+(t.global?"":"g"));for(;null!==(s=r.exec(e));)i.push([s.index,s.index+s[0].length]);return i}function u(e,t){return(null==e?void 0:e.content)&&Array.isArray(t)?t.reduce(((t,i)=>{try{const s=f(e.content,i);void 0!==s&&(t[i]=m(s))}catch(e){console.warn(`Error processing field ${i}:`,e)}return t}),{}):{}}function m(e){if(null==e)return"";try{return"string"==typeof e?e.toLowerCase().trim():Array.isArray(e)?e.map(m).filter(Boolean).join(" "):"object"==typeof e?Object.values(e).map(m).filter(Boolean).join(" "):String(e).toLowerCase().trim()}catch(e){return console.warn("Error normalizing field value:",e),""}}function f(e,t){if(e&&t)try{return t.split(".").reduce(((e,t)=>{if(null!==e&&"object"==typeof e){if(Array.isArray(e)){const i=parseInt(t,10);return isNaN(i)?void 0:e[i]}return e[t]}}),e)}catch(e){return void console.warn(`Error getting nested value for path ${t}:`,e)}}function g(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(g):Object.keys(e).sort().reduce(((t,i)=>(t[i]=g(e[i]),t)),{}):e}function p(e){if(!(null==e?void 0:e.id)||!e.content)return"";try{return`${e.id}:${Object.keys(e.content).sort().join(",")}`}catch(t){return e.id}}function w(e){if(e.maxResults&&e.maxResults<1)throw new Error("maxResults must be greater than 0");if(e.threshold&&(e.threshold<0||e.threshold>1))throw new Error("threshold must be between 0 and 1");if(e.fields&&!Array.isArray(e.fields))throw new Error("fields must be an array")}class y{getSize(){return this.documents.size}getAllDocuments(){return this.documents}constructor(e){this.config=e,this.indexMapper=new c,this.documents=new Map}addDocument(e){const t=e.id||this.generateDocumentId(this.documents.size);this.documents.set(t,e);const i={};for(const t of this.config.fields)t in e.fields&&(i[t]=e.fields[t]);const s={id:t,content:u({content:i,id:t},this.config.fields),metadata:e.metadata};this.indexMapper.indexDocument(s,t,this.config.fields)}getDocument(e){return this.documents.get(e)}exportIndex(){return{documents:Array.from(this.documents.entries()).map((([e,t])=>({key:e,value:this.serializeDocument(t)}))),indexState:this.indexMapper.exportState(),config:this.config}}importIndex(e){if(!this.isValidIndexData(e))throw new Error("Invalid index data format");try{const t=e;if(this.documents=new Map(t.documents.map((e=>[e.key,e.value]))),this.config=t.config,this.indexMapper=new c,!this.isValidIndexState(t.indexState))throw new Error("Invalid index state format");this.indexMapper.importState({trie:t.indexState.trie,dataMap:t.indexState.dataMap})}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to import index: ${t}`)}}clear(){this.documents.clear(),this.indexMapper=new c}generateDocumentId(e){return`${this.config.name}-${e}-${Date.now()}`}isValidIndexData(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean(t.documents&&Array.isArray(t.documents)&&void 0!==t.indexState&&t.config&&"object"==typeof t.config)}isValidIndexState(e){return null!==e&&"object"==typeof e&&"trie"in e&&"dataMap"in e}serializeDocument(e){return JSON.parse(JSON.stringify(e))}async addDocuments(e){for(const t of e){const e=t.id||this.generateDocumentId(this.documents.size);try{const i={};for(const e of this.config.fields)e in t.fields&&(i[e]=t.fields[e]);const s={id:e,content:u({content:i,id:e},this.config.fields),metadata:t.metadata};this.documents.set(e,{...t,id:e}),await this.indexMapper.indexDocument(s,e,this.config.fields)}catch(t){console.warn(`Failed to index document ${e}:`,t)}}}async updateDocument(e){const t=e.id;if(!this.documents.has(t))throw new Error(`Document ${t} not found`);try{this.documents.set(t,e);const i={};for(const t of this.config.fields)t in e.fields&&(i[t]=e.fields[t]);const s={id:t,content:u({content:i,id:t},this.config.fields),metadata:e.metadata};await this.indexMapper.updateDocument(s,t,this.config.fields)}catch(e){throw console.error(`Failed to update document ${t}:`,e),e}}async removeDocument(e){try{this.documents.has(e)&&(await this.indexMapper.removeDocument(e),this.documents.delete(e))}catch(t){throw console.error(`Failed to remove document ${e}:`,t),t}}async search(e,t={}){var i,s;if(!(null==e?void 0:e.trim()))return[];try{return(await this.indexMapper.search(e,{fuzzy:null!==(i=t.fuzzy)&&void 0!==i&&i,maxResults:null!==(s=t.maxResults)&&void 0!==s?s:10})).filter((e=>this.documents.has(e.item))).map((t=>{const i=this.documents.get(t.item);return{id:i.id,docId:i.id,term:e,document:i,metadata:i.metadata,item:i,score:t.score,matches:t.matches}})).filter((e=>{var i;return e.score>=(null!==(i=t.threshold)&&void 0!==i?i:.5)}))}catch(e){return console.error("Search error:",e),[]}}hasDocument(e){return this.documents.has(e)}}class v{constructor(){this.STOP_WORDS=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","were","will","with","this","they","but","have","had","what","when","where","who","which","why","how"]),this.WORD_ENDINGS={PLURAL:/(ies|es|s)$/i,GERUND:/ing$/i,PAST_TENSE:/(ed|d)$/i,COMPARATIVE:/er$/i,SUPERLATIVE:/est$/i,ADVERB:/ly$/i},this.SPECIAL_CHARS=/[!@#$%^&*(),.?":{}|<>]/g}process(e){if(!e)return"";const t=this.sanitizeQuery(String(e)),{phrases:i,remaining:s}=this.extractPhrases(t),r=this.tokenize(s),n=this.processTokens(r);return this.reconstructQuery(n,i)}sanitizeQuery(e){return e.trim().replace(/\s+/g," ").replace(/['"]/g,'"')}extractPhrases(e){const t=[];let i=e;return i=i.replace(/"([^"]+)"|"([^"]*$)/g,((e,i)=>i?(t.push(`"${i.trim()}"`)," "):"")),{phrases:t,remaining:i.trim()}}tokenize(e){return e.split(/\s+/).filter((e=>e.length>0)).map((e=>this.createToken(e)))}createToken(e){const t=e.toLowerCase();if(["+","-","!"].includes(e[0]))return{type:"operator",value:e,original:e};if(e.includes(":")){const[t,i]=e.split(":");return{type:"modifier",value:`${t.toLowerCase()}:${i}`,field:t,original:e}}return{type:"term",value:t,original:e}}processTokens(e){return e.filter((e=>this.shouldKeepToken(e))).map((e=>this.normalizeToken(e)))}shouldKeepToken(e){return"term"!==e.type||!this.STOP_WORDS.has(e.value.toLowerCase())}normalizeToken(e){if("term"!==e.type)return e;let t=e.value;return this.SPECIAL_CHARS.test(t)?e:(t=this.normalizeWordEndings(t),{...e,value:t})}normalizeWordEndings(e){if(e.length<=3)return e;let t=e;return this.isNormalizationException(e)||(this.WORD_ENDINGS.SUPERLATIVE.test(t)?t=t.replace(this.WORD_ENDINGS.SUPERLATIVE,""):this.WORD_ENDINGS.COMPARATIVE.test(t)?t=t.replace(this.WORD_ENDINGS.COMPARATIVE,""):this.WORD_ENDINGS.GERUND.test(t)?t=this.normalizeGerund(t):this.WORD_ENDINGS.PAST_TENSE.test(t)?t=this.normalizePastTense(t):this.WORD_ENDINGS.PLURAL.test(t)&&(t=this.normalizePlural(t))),t}isNormalizationException(e){return new Set(["this","his","is","was","has","does","series","species"]).has(e.toLowerCase())}normalizeGerund(e){return/[^aeiou]{2}ing$/.test(e)?e.slice(0,-4):/ying$/.test(e)?e.slice(0,-4)+"y":e.slice(0,-3)}normalizePastTense(e){return/[^aeiou]{2}ed$/.test(e)?e.slice(0,-3):/ied$/.test(e)?e.slice(0,-3)+"y":e.slice(0,-2)}normalizePlural(e){return/ies$/.test(e)?e.slice(0,-3)+"y":/[sxz]es$|[^aeiou]hes$/.test(e)?e.slice(0,-2):e.slice(0,-1)}reconstructQuery(e,t){return[...t,e.map((e=>e.value)).join(" ")].filter((e=>e.length>0)).join(" ").trim().replace(/\s+/g," ")}}class S{get id(){return this._id}get fields(){return{...this._fields}}get metadata(){return{...this._metadata}}get versions(){return[...this._versions]}get relations(){return[...this._relations]}constructor(e){this._id=e.id||this.generateId(),this._fields=this.normalizeFields(e.fields,e.content),this._metadata=this.normalizeMetadata(e.metadata),this._versions=e.versions||[],this._relations=e.relations||[]}normalizeFields(e,t){const i=(new Date).toISOString();return{title:(null==e?void 0:e.title)||"",content:this.normalizeContent((null==e?void 0:e.content)||t),type:(null==e?void 0:e.type)||"document",tags:Array.isArray(null==e?void 0:e.tags)?[...e.tags]:[],category:(null==e?void 0:e.category)||"",author:(null==e?void 0:e.author)||"",created:(null==e?void 0:e.created)||i,modified:(null==e?void 0:e.modified)||i,status:(null==e?void 0:e.status)||"draft",version:(null==e?void 0:e.version)||"1.0",locale:(null==e?void 0:e.locale)||""}}normalizeMetadata(e){var t,i;const s=Date.now();return{indexed:null!==(t=null==e?void 0:e.indexed)&&void 0!==t?t:s,lastModified:null!==(i=null==e?void 0:e.lastModified)&&void 0!==i?i:s,checksum:null==e?void 0:e.checksum,permissions:(null==e?void 0:e.permissions)||[],workflow:null==e?void 0:e.workflow}}normalizeContent(e){return"string"==typeof e?{text:e}:e||{}}clone(){return new S({id:this._id,fields:{...this._fields},metadata:{...this._metadata},versions:[...this._versions],relations:[...this._relations]})}update(e){var t;const i=e.fields?{...this._fields,...e.fields,modified:(new Date).toISOString()}:this._fields,s=e.metadata?{...this._metadata,...e.metadata,lastModified:Date.now()}:this._metadata,r=[...this._versions];return(null===(t=e.fields)||void 0===t?void 0:t.content)&&e.fields.content!==this._fields.content&&r.push({version:r.length+1,content:this._fields.content,modified:new Date,author:this._fields.author}),new S({id:this._id,fields:i,metadata:s,versions:r,relations:e.relations||this._relations})}document(){return new r(this._id,this._fields,this._metadata,this._versions,this._relations)}toObject(){return{id:this._id,fields:this._fields,metadata:this._metadata,versions:this._versions,relations:this._relations,document:()=>this.document(),clone:()=>this.clone(),update:e=>this.update(e),toObject:()=>this.toObject()}}static async initialize(e={}){var t,i;const s=this.getDefaultConfig();this.config={...s,...e,versioning:{enabled:!0,maxVersions:null!==(i=null===(t=e.versioning)||void 0===t?void 0:t.maxVersions)&&void 0!==i?i:s.versioning.maxVersions},validation:{...s.validation,...e.validation}},this.searchEngine=new x({name:this.config.name,version:this.config.version,fields:this.config.fields,storage:this.config.storage,documentSupport:{enabled:!0,versioning:{enabled:!0,maxVersions:this.config.versioning.maxVersions},validation:this.config.validation}}),await this.searchEngine.initialize()}static getDefaultConfig(){return{name:"nexus-document",version:1,fields:["title","content","type","tags","category","author"],storage:{type:"memory"},versioning:{enabled:!0,maxVersions:10},validation:{required:["title","content"],customValidators:{}}}}static async search(e,t={}){return(await this.searchEngine.search(e,t)).map((e=>({...e,item:new S(this.convertToNexusDocument(e.item))})))}static convertToNexusDocument(e){return{id:e.id,fields:{...e.fields,type:"document",created:e.fields.modified||(new Date).toISOString(),status:"draft"},metadata:e.metadata,versions:e.versions,relations:e.relations}}static async create(e){this.validateDocument(e);const t=new S({fields:{title:e.title,content:e.content,type:e.type,tags:e.tags||[],category:e.category,author:e.author,created:(new Date).toISOString(),modified:(new Date).toISOString(),status:e.status||"draft",version:"1.0",locale:e.locale},metadata:new S({}).normalizeMetadata(e.metadata)});return await t.save(),t}static async get(e){const t=await this.searchEngine.getDocument(e);if(!t)throw new Error(`Document ${e} not found`);return new S(this.convertToNexusDocument(t))}async save(){S.validateDocument(this._fields),await S.searchEngine.updateDocument(this.document())}async delete(){await S.searchEngine.removeDocument(this._id)}generateId(){return`doc-${Date.now()}-${Math.random().toString(36).slice(2,9)}`}static validateDocument(e){const{required:t=[],customValidators:i={}}=this.config.validation;for(const i of t)if(!e[i])throw new Error(`Field '${i}' is required`);for(const[t,s]of Object.entries(i)){const i=e[t];if(void 0!==i&&!s(i))throw new Error(`Validation failed for field '${t}'`)}}}class x{constructor(e){var t,r;this.isInitialized=!1,this.config=e,this.indexManager=new y(e),this.queryProcessor=new v,this.storage=new s(e.storage),this.cache=new i,this.eventListeners=new Set,this.trie=new a,this.documents=new Map,this.documentSupport=null!==(r=null===(t=e.documentSupport)||void 0===t?void 0:t.enabled)&&void 0!==r&&r,this.config=e,this.indexManager=new y(e),this.queryProcessor=new v,this.storage=new s(e.storage),this.cache=new i,this.eventListeners=new Set,this.trie=new a,this.documents=new Map,this.trieRoot={id:"",value:"",score:0,children:new Map,depth:0}}extractRegexMatches(e,t,i){const s=i.fields||this.config.fields,r=new Set;for(const i of s){const s=String(e.fields[i]||"");for(const[e,i]of t)e>=0&&i<=s.length&&r.add(s.slice(e,i))}return Array.from(r)}async initialize(){if(!this.isInitialized)try{try{await this.storage.initialize()}catch(e){this.emitEvent({type:"storage:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),this.storage=new s({type:"memory"}),await this.storage.initialize()}await this.loadIndexes(),this.isInitialized=!0,this.emitEvent({type:"engine:initialized",timestamp:Date.now()})}catch(e){throw new Error(`Failed to initialize search engine: ${String(e)}`)}}async addDocument(e){await this.addDocuments([e])}async addDocuments(e){var t,i,s,r,n;this.isInitialized||await this.initialize();try{const o=e.map((e=>this.normalizeDocument(e)));this.documentSupport&&(null===(t=this.config.documentSupport)||void 0===t?void 0:t.validation)&&this.validateDocuments(o);for(const e of o){this.documents.set(e.id,e);const t=new S({id:e.id,fields:{...e.fields,title:String(e.fields.title||""),content:this.normalizeContent(e.fields.content),author:String(e.fields.author||""),type:String(e.fields.type||"document"),tags:Array.isArray(e.fields.tags)?e.fields.tags.map(String):[],category:String(e.fields.category||""),created:this.normalizeDate(e.fields.created)||(new Date).toISOString(),modified:this.normalizeDate(e.fields.modified)||(new Date).toISOString(),status:this.normalizeStatus(e.fields.status)||"draft",version:String(e.fields.version||"1.0"),locale:String(e.fields.locale||"")},metadata:{...e.metadata,indexed:null!==(s=null===(i=e.metadata)||void 0===i?void 0:i.indexed)&&void 0!==s?s:Date.now(),lastModified:null!==(n=null===(r=e.metadata)||void 0===r?void 0:r.lastModified)&&void 0!==n?n:Date.now()},versions:e.versions,relations:e.relations});this.trie.addDocument(t),this.indexManager.addDocument(t)}await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex()),this.cache.clear(),this.emitEvent({type:"index:complete",timestamp:Date.now(),data:{documentCount:e.length}})}catch(e){throw this.emitEvent({type:"index:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),e}}normalizeContent(e){return e?"string"==typeof e?{text:e}:"object"==typeof e?e:{value:String(e)}:{}}normalizeDate(e){if(e)return e instanceof Date?e.toISOString():"string"==typeof e||"number"==typeof e?new Date(e).toISOString():void 0}normalizeStatus(e){if(!e)return;const t=String(e).toLowerCase();switch(t){case"draft":case"published":case"archived":return t;case"active":return"published";default:return"draft"}}async updateDocument(e){var t,i;this.isInitialized||await this.initialize();const s=this.normalizeDocument(e);await this.handleVersioning(s),this.documentSupport&&(null===(i=null===(t=this.config.documentSupport)||void 0===t?void 0:t.versioning)||void 0===i?void 0:i.enabled)&&await this.handleVersioning(s),this.documents.set(s.id,s),this.trie.addDocument(s),await this.indexManager.updateDocument(s)}async search(e,t={}){this.isInitialized||await this.initialize(),w(t);const i=Date.now();this.emitEvent({type:"search:start",timestamp:i,data:{query:e,options:t}});const s=this.generateCacheKey(e,t),r=this.cache.get(s);if(r)return r;try{let r;if(t.regex)r=await this.performRegexSearch(e,t);else{const i=this.queryProcessor.process(e).toLowerCase().split(/\s+/).filter(Boolean);r=await this.performBasicSearch(i,t)}const n=await this.processSearchResults(r,t);return this.cache.set(s,n),this.emitEvent({type:"search:complete",timestamp:Date.now(),data:{query:e,options:t,resultCount:n.length,searchTime:Date.now()-i}}),n}catch(e){throw this.emitEvent({type:"search:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Search failed: ${e}`)}}async performRegexSearch(e,t){var i,s,r,n;const o={maxDepth:(null===(i=t.regexConfig)||void 0===i?void 0:i.maxDepth)||50,timeoutMs:(null===(s=t.regexConfig)||void 0===s?void 0:s.timeoutMs)||5e3,caseSensitive:(null===(r=t.regexConfig)||void 0===r?void 0:r.caseSensitive)||!1,wholeWord:(null===(n=t.regexConfig)||void 0===n?void 0:n.wholeWord)||!1},a=this.createRegexFromOption(t.regex||""),c=this.isComplexRegex(a)?await function(e,t,i=10,s={}){const{maxDepth:r=50,timeoutMs:n=5e3,caseSensitive:o=!1,wholeWord:a=!1}=s,c=d(t,{caseSensitive:o,wholeWord:a}),u=[],m=new Set,f=Date.now();return function e(t,s,o,a){if(!(u.length>=i||o>r||Date.now()-f>n)){c.test(s)&&t.id&&!m.has(t.id)&&(u.push({id:t.id,score:h(t,s,c),matches:[s],path:[...a],positions:l(s,c)}),m.add(t.id));for(const[i,r]of t.children.entries())e(r,s+i,o+1,[...a,i])}}(e,"",0,[]),u.sort(((e,t)=>t.score-e.score))}(this.trieRoot,a,t.maxResults||10,o):await function(e,t,i=10,s={}){const{maxDepth:r=50,timeoutMs:n=5e3,caseSensitive:o=!1,wholeWord:a=!1}=s,c=d(t,{caseSensitive:o,wholeWord:a}),u=[],m=[],f=new Set,g=Date.now();for(m.push({node:e,matched:"",depth:0,path:[]});m.length>0&&u.length<i;){if(Date.now()-g>n){console.warn("BFS regex search timeout");break}const e=m.shift(),{node:t,matched:i,depth:s,path:o}=e;if(!(s>r)){c.test(i)&&t.id&&!f.has(t.id)&&(u.push({id:t.id,score:h(t,i,c),matches:[i],path:[...o],positions:l(i,c)}),f.add(t.id));for(const[e,r]of t.children.entries())m.push({node:r,matched:i+e,depth:s+1,path:[...o,e]})}}return u.sort(((e,t)=>t.score-e.score))}(this.trieRoot,a,t.maxResults||10,o);return c.map((t=>{const i=this.documents.get(t.id);if(!i)throw new Error(`Document not found for id: ${t.id}`);return{id:t.id,docId:t.id,term:t.matches[0]||e,score:t.score,matches:t.matches,document:i,item:i,metadata:{...i.metadata,lastAccessed:Date.now()}}})).filter((e=>e.score>=(t.minScore||0)))}async performBasicSearch(e,t){const i=new Map;for(const s of e){const e=t.fuzzy?this.trie.fuzzySearch(s,t.maxDistance||2):this.trie.search(s);for(const r of e){const e=r.docId,n=i.get(e)||{score:0,matches:new Set};n.score+=this.calculateTermScore(s,e,t),n.matches.add(s),i.set(e,n)}}return Array.from(i.entries()).map((([e,{score:t}])=>({id:e,score:t}))).sort(((e,t)=>t.score-e.score))}createRegexFromOption(e){if(e instanceof RegExp)return e;if("string"==typeof e)return new RegExp(e);if("object"==typeof e&&null!==e){const t=e.pattern,i=e.flags;return new RegExp(t||"",i||"")}return new RegExp("")}isComplexRegex(e){const t=e.source;return t.includes("{")||t.includes("+")||t.includes("*")||t.includes("?")||t.includes("|")||t.includes("(?")||t.includes("[")||t.length>20}async processSearchResults(e,t){const i=[];for(const s of e){const e=this.documents.get(s.id);if(!e)continue;const r={id:s.id,docId:s.id,item:e,score:s.score?this.normalizeScore(s.score):s.score,matches:[],metadata:{...e.metadata,lastAccessed:Date.now()},document:e,term:"matched"in s?String(s.matched):""};t.includeMatches&&(r.matches="positions"in s?this.extractRegexMatches(e,s.positions,t):this.extractMatches(e,t)),i.push(r)}return this.applyPagination(i,t)}getTrieState(){return this.trie.serializeState()}validateDocuments(e){var t;if(!(null===(t=this.config.documentSupport)||void 0===t?void 0:t.validation))return;const{required:i=[],customValidators:s={}}=this.config.documentSupport.validation;for(const t of e){for(const e of i)if(!t.fields[e])throw new Error(`Field '${e}' is required for document ${t.id}`);Object.entries(s).forEach((([e,i])=>{const s=t.fields[e];if(void 0!==s&&!i(s))throw new Error(`Validation failed for field '${e}' in document ${t.id}`)}))}}async removeDocument(e){if(this.isInitialized||await this.initialize(),!this.documents.has(e))throw new Error(`Document ${e} not found`);try{this.documents.delete(e),this.trie.removeDocument(e),await this.indexManager.removeDocument(e),this.cache.clear();try{await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())}catch(e){this.emitEvent({type:"storage:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))})}this.emitEvent({type:"remove:complete",timestamp:Date.now(),data:{documentId:e}})}catch(e){throw this.emitEvent({type:"remove:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to remove document: ${e}`)}}async clearIndex(){this.isInitialized||await this.initialize();try{await this.storage.clearIndices(),this.documents.clear(),this.trie=new a,this.indexManager.clear(),this.cache.clear(),this.emitEvent({type:"index:clear",timestamp:Date.now()})}catch(e){throw this.emitEvent({type:"index:clear:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to clear index: ${e}`)}}calculateTermScore(e,t,i){var s;const r=this.documents.get(t);if(!r)return 0;const n=i.fields||this.config.fields;let o=0;for(const t of n){const n=String(r.fields[t]||"").toLowerCase(),a=(null===(s=i.boost)||void 0===s?void 0:s[t])||1;o+=(n.match(new RegExp(e,"gi"))||[]).length*a}return o}normalizeScore(e){return Math.min(Math.max(e/100,0),1)}extractMatches(e,t){const i=new Set,s=t.fields||this.config.fields;for(const r of s){const s=String(e.fields[r]||"").toLowerCase();if(t.regex){const e="string"==typeof t.regex?new RegExp(t.regex,"gi"):new RegExp(t.regex.source,"gi");(s.match(e)||[]).forEach((e=>i.add(e)))}}return Array.from(i)}applyPagination(e,t){const i=t.page||1,s=t.pageSize||10,r=(i-1)*s;return e.slice(r,r+s)}async loadIndexes(){try{const e=await this.storage.getIndex(this.config.name);if(e){this.indexManager.importIndex(e);const t=this.indexManager.getAllDocuments();for(const e of t)this.documents.set(e[1].id,r.fromObject({id:e[1].id,fields:{title:e[1].fields.title,content:e[1].fields.content,author:e[1].fields.author,tags:e[1].fields.tags,version:e[1].fields.version},metadata:e[1].metadata}))}}catch(e){console.warn("Failed to load stored index, starting fresh:",e)}}generateCacheKey(e,t){return`${this.config.name}-${e}-${JSON.stringify(t)}`}addEventListener(e){this.eventListeners.add(e)}removeEventListener(e){this.eventListeners.delete(e)}emitEvent(e){this.eventListeners.forEach((t=>{try{t(e)}catch(e){console.error("Error in event listener:",e)}}))}async close(){try{await this.storage.close(),this.cache.clear(),this.documents.clear(),this.isInitialized=!1,this.emitEvent({type:"engine:closed",timestamp:Date.now()})}catch(e){console.warn("Error during close:",e)}}getIndexedDocumentCount(){return this.documents.size}async bulkUpdate(e){this.isInitialized||await this.initialize();const t=[];for(const[i,s]of e){const e=this.documents.get(i);if(e){const n=new r(i,{...e.fields,...s.fields},{...e.metadata,...s.metadata});t.push(this.updateDocument(n))}}try{await Promise.all(t),this.emitEvent({type:"bulk:update:complete",timestamp:Date.now(),data:{updateCount:e.size}})}catch(e){throw this.emitEvent({type:"bulk:update:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Bulk update failed: ${e}`)}}async importIndex(e){this.isInitialized||await this.initialize();try{await this.clearIndex(),this.indexManager.importIndex(e);const t=Array.from(this.documents.values()).map((e=>r.fromObject(e)));await this.addDocuments(t),this.emitEvent({type:"import:complete",timestamp:Date.now(),data:{documentCount:this.documents.size}})}catch(e){throw this.emitEvent({type:"import:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Import failed: ${e}`)}}exportIndex(){if(!this.isInitialized)throw new Error("Search engine not initialized");return this.indexManager.exportIndex()}getDocument(e){return this.documents.get(e)}getAllDocuments(){return Array.from(this.documents.values())}async reindexAll(){this.isInitialized||await this.initialize();try{const e=this.getAllDocuments();await this.clearIndex(),await this.addDocuments(e),this.emitEvent({type:"reindex:complete",timestamp:Date.now(),data:{documentCount:e.length}})}catch(e){throw this.emitEvent({type:"reindex:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Reindex failed: ${e}`)}}async optimizeIndex(){this.isInitialized||await this.initialize();try{this.cache.clear(),this.storage instanceof s&&(await this.storage.clearIndices(),await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())),this.emitEvent({type:"optimize:complete",timestamp:Date.now()})}catch(e){throw this.emitEvent({type:"optimize:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Optimization failed: ${e}`)}}async handleVersioning(e){var t,i,s;const r=await this.getDocument(e.id);if(!r)return;const n=null!==(s=null===(i=null===(t=this.config.documentSupport)||void 0===t?void 0:t.versioning)||void 0===i?void 0:i.maxVersions)&&void 0!==s?s:10,o=r.versions||[];e.fields.content!==r.fields.content&&(o.push({version:Number(r.fields.version),content:r.fields.content,modified:new Date(r.fields.modified||Date.now()),author:r.fields.author}),o.length>n&&o.splice(0,o.length-n),e.versions=o,e.fields.version=String(Number(e.fields.version)+1))}normalizeDocument(e){var t,i;if(!this.documentSupport)return e;const s={title:e.fields.title||"",content:e.fields.content,author:e.fields.author||"",tags:Array.isArray(e.fields.tags)?e.fields.tags:[],version:e.fields.version||"1.0"},n={indexed:(null===(t=e.metadata)||void 0===t?void 0:t.indexed)||Date.now(),lastModified:(null===(i=e.metadata)||void 0===i?void 0:i.lastModified)||Date.now()};return new r(e.id,s,n)}async restoreVersion(e,t){if(!this.documentSupport)throw new Error("Document support is not enabled");const i=await this.getDocument(e);if(!i)throw new Error(`Document ${e} not found`);const s=await this.getDocumentVersion(e,t);if(!s)throw new Error(`Version ${t} not found for document ${e}`);const n=new r(i.id,{...i.fields,content:s.content,modified:(new Date).toISOString(),version:String(Number(i.fields.version)+1)},{...i.metadata,lastModified:Date.now()});await this.updateDocument(n)}async getDocumentVersion(e,t){var i;if(!this.documentSupport)throw new Error("Document support is not enabled");const s=await this.getDocument(e);return null===(i=null==s?void 0:s.versions)||void 0===i?void 0:i.find((e=>e.version===t))}getStats(){return{documentCount:this.documents.size,indexSize:this.indexManager.getSize(),cacheSize:this.cache.getSize(),initialized:this.isInitialized}}isReady(){return this.isInitialized}}class E extends Error{constructor(e){super(e),this.name="ValidationError"}}class D extends Error{constructor(e){super(e),this.name="StorageError"}}class z extends Error{constructor(e){super(e),this.name="CacheError"}}class M extends Error{constructor(e){super(e),this.name="MapperError"}}class I extends Error{constructor(e){super(e),this.name="PerformanceError"}}class b extends Error{constructor(e){super(e),this.name="ConfigError"}}class R extends Error{constructor(e,t,i){super(e),this.type=t,this.details=i,this.name="SearchEventError"}}var A;e.CacheStrategyType=void 0,(A=e.CacheStrategyType||(e.CacheStrategyType={})).LRU="LRU",A.MRU="MRU";class O extends Error{constructor(e){super(e),this.name="SearchError"}}class C extends Error{constructor(e){super(e),this.name="IndexError"}}function $(e){if(!e||"object"!=typeof e)return!1;const t=e;return(void 0===t.fuzzy||"boolean"==typeof t.fuzzy)&&(void 0===t.maxResults||"number"==typeof t.maxResults)&&(void 0===t.threshold||"number"==typeof t.threshold)&&(void 0===t.fields||Array.isArray(t.fields))&&(void 0===t.sortBy||"string"==typeof t.sortBy)&&(void 0===t.sortOrder||["asc","desc"].includes(t.sortOrder))&&(void 0===t.page||"number"==typeof t.page)&&(void 0===t.pageSize||"number"==typeof t.pageSize)&&(void 0===t.regex||"string"==typeof t.regex||t.regex instanceof RegExp)&&(void 0===t.boost||"object"==typeof t.boost&&null!==t.boost)}function T(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean("string"==typeof t.name&&"number"==typeof t.version&&Array.isArray(t.fields))}function _(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean("id"in t&&"item"in t&&"document"in t&&"number"==typeof t.score&&Array.isArray(t.matches))}const k={DEFAULT_INDEX_OPTIONS:{fields:[]},DEFAULT_SEARCH_OPTIONS:{fuzzy:!1,fields:[],boost:{},maxResults:10,threshold:.5,sortBy:"score",sortOrder:"desc",page:1,pageSize:10,highlight:!1,includeMatches:!1,includeScore:!1,includeStats:!1,enableRegex:!1,maxDistance:0,regex:/./,prefixMatch:!1,minScore:0,includePartial:!1,caseSensitive:!1},SearchError:O,IndexError:C,SearchEngine:x,IndexManager:y,QueryProcessor:v,TrieNode:o,TrieSearch:a,isSearchOptions:$,isIndexConfig:T,isSearchResult:_};"undefined"!=typeof window&&(window.NexusSearch=k);const N=k;e.CacheError=z,e.CacheManager=i,e.ConfigError=b,e.DataMapper=n,e.IndexError=C,e.IndexManager=y,e.IndexMapper=c,e.IndexedDB=class{constructor(){this.db=null,this.DB_NAME="nexus_search_db",this.DB_VERSION=1,this.initPromise=null,this.initPromise=this.initialize()}async initialize(){if(!this.db)try{this.db=await t.openDB(this.DB_NAME,this.DB_VERSION,{upgrade(e){if(!e.objectStoreNames.contains("searchIndices")){e.createObjectStore("searchIndices",{keyPath:"id"}).createIndex("timestamp","timestamp")}if(!e.objectStoreNames.contains("metadata")){e.createObjectStore("metadata",{keyPath:"id"}).createIndex("lastUpdated","lastUpdated")}},blocked(){console.warn("Database upgrade was blocked")},blocking(){console.warn("Current database version is blocking a newer version")},terminated(){console.error("Database connection was terminated")}})}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Storage initialization failed: ${t}`)}}async ensureConnection(){if(this.initPromise&&await this.initPromise,!this.db)throw new Error("Database connection not available")}async storeIndex(e,t){await this.ensureConnection();try{const i={id:e,data:t,timestamp:Date.now()};await this.db.put("searchIndices",i)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to store index: ${t}`)}}async getIndex(e){var t;await this.ensureConnection();try{const i=await this.db.get("searchIndices",e);return null!==(t=null==i?void 0:i.data)&&void 0!==t?t:null}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to retrieve index: ${t}`)}}async updateMetadata(e){await this.ensureConnection();try{const t={id:"config",config:e,lastUpdated:Date.now()};await this.db.put("metadata",t)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to update metadata: ${t}`)}}async getMetadata(){await this.ensureConnection();try{const e=await this.db.get("metadata","config");return null!=e?e:null}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to retrieve metadata: ${t}`)}}async clearIndices(){await this.ensureConnection();try{await this.db.clear("searchIndices")}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to clear indices: ${t}`)}}async deleteIndex(e){await this.ensureConnection();try{await this.db.delete("searchIndices",e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to delete index: ${t}`)}}async close(){this.db&&(this.db.close(),this.db=null)}},e.MapperError=M,e.NexusSearch=N,e.PerformanceError=I,e.PerformanceMonitor=class{constructor(){this.metrics=new Map}async measure(e,t){const i=performance.now();try{return await t()}finally{const t=performance.now()-i;this.recordMetric(e,t)}}recordMetric(e,t){this.metrics.has(e)||this.metrics.set(e,[]),this.metrics.get(e).push(t)}getMetrics(){const e={};return this.metrics.forEach(((t,i)=>{e[i]={avg:this.average(t),min:Math.min(...t),max:Math.max(...t),count:t.length}})),e}average(e){return e.reduce(((e,t)=>e+t),0)/e.length}clear(){this.metrics.clear()}},e.QueryProcessor=v,e.SearchEngine=x,e.SearchError=O,e.SearchEventError=R,e.StorageError=D,e.TrieNode=o,e.TrieSearch=a,e.ValidationError=E,e.createSearchableFields=u,e.default=N,e.getNestedValue=f,e.isIndexConfig=T,e.isSearchOptions=$,e.isSearchResult=_,e.normalizeFieldValue=m,e.optimizeIndex=function(e){if(!Array.isArray(e))return{data:[],stats:{originalSize:0,optimizedSize:0,compressionRatio:1}};try{const t=new Map;e.forEach((e=>{const i=JSON.stringify(g(e));t.set(i,e)}));const i=Array.from(t.values()).sort(((e,t)=>p(e).localeCompare(p(t))));return{data:i,stats:{originalSize:e.length,optimizedSize:i.length,compressionRatio:e.length?i.length/e.length:1}}}catch(t){return console.warn("Error optimizing index:",t),{data:e,stats:{originalSize:e.length,optimizedSize:e.length,compressionRatio:1}}}},e.validateDocument=function(e,t){return t.every((t=>void 0!==f(e.content,t)))},e.validateIndexConfig=function(e){if(!e.name)throw new Error("Index name is required");if(!e.version||"number"!=typeof e.version)throw new Error("Valid version number is required");if(!Array.isArray(e.fields)||0===e.fields.length)throw new Error("At least one field must be specified for indexing")},e.validateSearchOptions=w,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
