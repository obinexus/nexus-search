/**
 * @obinexuscomputing/nexus-search v0.1.56rc
 * A high-performance search indexing and query system that uses a trie data structure and BFS/DFS algorithms for fast full-text search with fuzzy matching.
 * @license ISC
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("idb")):"function"==typeof define&&define.amd?define(["exports","idb"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NexusSearch={},e.idb)}(this,(function(e,t){"use strict";class r{getSize(){return this.cache.size}getStatus(){const e=Array.from(this.cache.values()).map((e=>e.timestamp)),t=Date.now(),r=this.calculateMemoryUsage();return{size:this.cache.size,maxSize:this.maxSize,strategy:this.strategy,ttl:this.ttl,utilization:this.cache.size/this.maxSize,oldestEntryAge:e.length?t-Math.min(...e):null,newestEntryAge:e.length?t-Math.max(...e):null,memoryUsage:{bytes:r,formatted:this.formatBytes(r)}}}calculateMemoryUsage(){let e=0;for(const[t,r]of this.cache.entries())e+=2*t.length,e+=24,e+=this.estimateDataSize(r.data);return e+=8*(3+this.accessOrder.length+3),e}estimateDataSize(e){let t=0;for(const r of e)t+=8,t+=2*r.matches.join("").length,t+=2*JSON.stringify(r.item).length,r.metadata&&(t+=2*JSON.stringify(r.metadata).length);return t}formatBytes(e){const t=["B","KB","MB","GB"];let r=e,i=0;for(;r>=1024&&i<t.length-1;)r/=1024,i++;return`${r.toFixed(2)} ${t[i]}`}constructor(e=1e3,t=5,r="LRU"){this.cache=new Map,this.maxSize=e,this.ttl=60*t*1e3,this.strategy=r,this.accessOrder=[],this.stats={hits:0,misses:0,evictions:0}}set(e,t){this.cache.size>=this.maxSize&&this.evict();const r={data:t,timestamp:Date.now(),lastAccessed:Date.now(),accessCount:1};this.cache.set(e,r),this.updateAccessOrder(e)}get(e){const t=this.cache.get(e);return t?this.isExpired(t.timestamp)?(this.cache.delete(e),this.removeFromAccessOrder(e),this.stats.misses++,null):(t.lastAccessed=Date.now(),t.accessCount++,this.updateAccessOrder(e),this.stats.hits++,t.data):(this.stats.misses++,null)}clear(){this.cache.clear(),this.accessOrder=[],this.stats={hits:0,misses:0,evictions:0}}getStats(){return{...this.stats,size:this.cache.size,maxSize:this.maxSize,hitRate:this.stats.hits/(this.stats.hits+this.stats.misses),strategy:this.strategy}}isExpired(e){return Date.now()-e>this.ttl}evict(){const e="LRU"===this.strategy?this.findLRUKey():this.findMRUKey();e&&(this.cache.delete(e),this.removeFromAccessOrder(e),this.stats.evictions++)}findLRUKey(){return this.accessOrder[0]||null}findMRUKey(){return this.accessOrder[this.accessOrder.length-1]||null}updateAccessOrder(e){this.removeFromAccessOrder(e),"LRU"===this.strategy?this.accessOrder.push(e):this.accessOrder.unshift(e)}removeFromAccessOrder(e){const t=this.accessOrder.indexOf(e);-1!==t&&this.accessOrder.splice(t,1)}setStrategy(e){if(e===this.strategy)return;this.strategy=e;const t=[...this.accessOrder];this.accessOrder=[],t.forEach((e=>this.updateAccessOrder(e)))}prune(){let e=0;for(const[t,r]of this.cache.entries())this.isExpired(r.timestamp)&&(this.cache.delete(t),this.removeFromAccessOrder(t),e++);return e}analyze(){const e=this.stats.hits+this.stats.misses,t=e>0?this.stats.hits/e:0;let r=0;const i=new Map;for(const[e,t]of this.cache.entries())r+=t.accessCount,i.set(e,t.accessCount);return{hitRate:t,averageAccessCount:this.cache.size>0?r/this.cache.size:0,mostAccessedKeys:Array.from(i.entries()).sort(((e,t)=>t[1]-e[1])).slice(0,5).map((([e,t])=>({key:e,count:t})))}}}class i{constructor(e={type:"memory"}){this.db=null,this.memoryStorage=new Map,this.storageType=this.determineStorageType(e)}determineStorageType(e){return"memory"!==e.type&&this.isIndexedDBAvailable()?"indexeddb":"memory"}isIndexedDBAvailable(){try{return"undefined"!=typeof indexedDB&&null!==indexedDB}catch(e){return!1}}async initialize(){if("memory"!==this.storageType)try{this.db=await t.openDB("nexus-search-db",1,{upgrade(e){e.createObjectStore("searchIndices",{keyPath:"id"}).createIndex("timestamp","timestamp");e.createObjectStore("metadata",{keyPath:"id"}).createIndex("lastUpdated","lastUpdated")}})}catch(e){this.storageType="memory",console.warn("Failed to initialize IndexedDB, falling back to memory storage:",e)}}async storeIndex(e,t){var r;if("memory"!==this.storageType)try{await(null===(r=this.db)||void 0===r?void 0:r.put("searchIndices",{id:e,data:t,timestamp:Date.now()}))}catch(r){console.error("Storage error:",r),this.memoryStorage.set(e,t)}else this.memoryStorage.set(e,t)}async getIndex(e){var t;if("memory"===this.storageType)return this.memoryStorage.get(e);try{const r=await(null===(t=this.db)||void 0===t?void 0:t.get("searchIndices",e));return null==r?void 0:r.data}catch(t){return console.error("Retrieval error:",t),this.memoryStorage.get(e)}}async clearIndices(){var e;if("memory"!==this.storageType)try{await(null===(e=this.db)||void 0===e?void 0:e.clear("searchIndices"))}catch(e){console.error("Clear error:",e),this.memoryStorage.clear()}else this.memoryStorage.clear()}async close(){this.db&&(this.db.close(),this.db=null),this.memoryStorage.clear()}}class s{constructor(e,t,r){this.versions=[],this.relations=[],this.id=e,this.fields=this.normalizeFields(t),this.metadata=this.normalizeMetadata(r)}normalizeFields(e){const t={title:"",content:"",author:"",tags:[],version:""};for(const r in e)void 0!==e[r]&&(t[r]=e[r]);return{...t,title:e.title||"",content:e.content||"",author:e.author||"",tags:e.tags||[]}}normalizeMetadata(e){return{indexed:Date.now(),lastModified:Date.now(),...e}}toObject(){return{id:this.id,fields:{...this.fields,tags:[...this.fields.tags]},metadata:this.metadata?{...this.metadata}:void 0,versions:[...this.versions],relations:[...this.relations],content:this.content,document:()=>this,clone:()=>this.clone(),update:e=>this.update(e)}}clone(){return new s(this.id,{...this.fields,tags:[...this.fields.tags]},this.metadata?{...this.metadata}:void 0)}update(e){const t={...this.fields};return e.fields&&Object.entries(e.fields).forEach((([e,r])=>{void 0!==r&&(t[e]=r)})),new s(this.id,t,{...this.metadata,...e.metadata,lastModified:Date.now()})}getField(e){return this.fields[e]}setField(e,t){this.fields[e]=t}document(){return this}static create(e){return new s(e.id,e.fields,e.metadata)}static fromObject(e){return s.create({id:e.id,fields:{...e.fields,title:e.fields.title,content:e.fields.content,author:e.fields.author,tags:e.fields.tags},metadata:e.metadata})}toJSON(){return{id:this.id,fields:this.fields,metadata:this.metadata,versions:this.versions,relations:this.relations}}toString(){return`IndexedDocument(${this.id})`}}class n{constructor(){this.dataMap=new Map}mapData(e,t){this.dataMap.has(e)||this.dataMap.set(e,new Set),this.dataMap.get(e).add(t)}getDocuments(e){return this.dataMap.get(e)||new Set}getDocumentById(e){const t=new Set;return this.dataMap.forEach((r=>{r.has(e)&&t.add(e)})),t}getAllKeys(){return Array.from(this.dataMap.keys())}removeDocument(e){this.dataMap.forEach((t=>{t.delete(e)}))}removeKey(e){this.dataMap.delete(e)}exportState(){const e={};return this.dataMap.forEach(((t,r)=>{e[r]=Array.from(t)})),e}importState(e){this.dataMap.clear(),Object.entries(e).forEach((([e,t])=>{this.dataMap.set(e,new Set(t))}))}clear(){this.dataMap.clear()}}class a{constructor(){this.children=new Map,this.isEndOfWord=!1,this.documentRefs=new Set,this.weight=0}}class o{constructor(){this.root=new a,this.documents=new Map,this.documentLinks=new Map}insert(e,t){if(!e||!t)return;const r=e.toLowerCase().split(/\s+/).filter(Boolean);for(const e of r){let r=this.root;for(const t of e)r.children.has(t)||r.children.set(t,new a),r=r.children.get(t);r.isEndOfWord=!0,r.documentRefs.add(t),r.weight+=1}}search(e,t=10){if(!e)return new Set;const r=new Set,i=e.toLowerCase().split(/\s+/).filter(Boolean);for(const e of i){let i=this.root,s=!0;for(const t of e){if(!i.children.has(t)){s=!1;break}i=i.children.get(t)}s&&i.isEndOfWord&&this.collectDocumentRefs(i,r,t)}return r}remove(e){for(const[,t]of this.root.children)this.removeHelper(e,t);this.documents.delete(e),this.documentLinks.delete(e)}removeHelper(e,t){t.documentRefs.has(e)&&(t.documentRefs.delete(e),t.weight-=1);for(const[,r]of t.children)this.removeHelper(e,r);0===t.children.size&&0===t.documentRefs.size&&0===t.weight&&t.children.clear()}linkDocument(e,t){this.documentLinks.set(e,t)}getDocumentLinks(e){var t;return null!==(t=this.documentLinks.get(e))&&void 0!==t?t:[]}removeData(e){this.remove(e)}fuzzySearch(e,t=2){if(!e)return new Set;const r=new Set,i=e.toLowerCase().split(/\s+/).filter(Boolean);for(const e of i)this.fuzzySearchHelper(e,this.root,"",t,r);return r}collectDocumentRefs(e,t,r){if(e.isEndOfWord)for(const i of e.documentRefs){if(t.size>=r)return;t.add(i)}for(const i of e.children.values()){if(t.size>=r)return;this.collectDocumentRefs(i,t,r)}}fuzzySearchHelper(e,t,r,i,s){if(!(i<0)){if(t.isEndOfWord){this.calculateLevenshteinDistance(e,r)<=i&&t.documentRefs.forEach((e=>s.add(e)))}for(const[n,a]of t.children){const t=e[r.length]!==n?i-1:i;this.fuzzySearchHelper(e,a,r+n,t,s),i>0&&this.fuzzySearchHelper(e,a,r,i-1,s)}}}calculateLevenshteinDistance(e,t){const r=Array(e.length+1).fill(0).map((()=>Array(t.length+1).fill(0)));for(let t=0;t<=e.length;t++)r[t][0]=t;for(let e=0;e<=t.length;e++)r[0][e]=e;for(let i=1;i<=e.length;i++)for(let s=1;s<=t.length;s++)r[i][s]=Math.min(r[i-1][s]+1,r[i][s-1]+1,r[i-1][s-1]+(e[i-1]!==t[s-1]?1:0));return r[e.length][t.length]}exportState(){return{trie:this.serializeNode(this.root),documents:Array.from(this.documents.entries()),documentLinks:Array.from(this.documentLinks.entries())}}importState(e){this.root=this.deserializeNode(e.trie),this.documents=new Map(e.documents),this.documentLinks=new Map(e.documentLinks)}serializeNode(e){const t={};return e.children.forEach(((e,r)=>{t[r]=this.serializeNode(e)})),{isEndOfWord:e.isEndOfWord,documentRefs:Array.from(e.documentRefs),weight:e.weight,children:t}}deserializeNode(e){var t;const r=new a;return r.isEndOfWord=e.isEndOfWord,r.documentRefs=new Set(e.documentRefs),r.weight=null!==(t=e.weight)&&void 0!==t?t:0,Object.entries(e.children).forEach((([e,t])=>{r.children.set(e,this.deserializeNode(t))})),r}clear(){this.root=new a,this.documents.clear(),this.documentLinks.clear()}getSize(){return this.documents.size}}class c{constructor(){this.dataMapper=new n,this.trieSearch=new o}indexDocument(e,t,r){r.forEach((r=>{const i=e[r];if("string"==typeof i){this.tokenizeText(i).forEach((e=>{this.trieSearch.insert(e,t),this.dataMapper.mapData(e.toLowerCase(),t)}))}}))}search(e,t={}){const{fuzzy:r=!1,maxResults:i=10}=t,s=this.tokenizeText(e),n=new Map;s.forEach((e=>{(r?this.trieSearch.fuzzySearch(e):this.trieSearch.search(e,i)).forEach((t=>{const r=n.get(t)||{score:0,matches:new Set};r.score+=this.calculateScore(t,e),r.matches.add(e),n.set(t,r)}))}));return Array.from(n.entries()).map((([e,{score:t,matches:r}])=>({id:e,document:this.dataMapper.getDocumentById(e),item:e,score:t/s.length,matches:Array.from(r)}))).sort(((e,t)=>t.score-e.score)).slice(0,i)}exportState(){return{trie:this.trieSearch.exportState(),dataMap:this.dataMapper.exportState()}}importState(e){if(!e||!e.trie||!e.dataMap)throw new Error("Invalid index state");this.trieSearch=new o,this.trieSearch.importState(e.trie),this.dataMapper=new n,this.dataMapper.importState(e.dataMap)}tokenizeText(e){return e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter((e=>e.length>0))}calculateScore(e,t){return this.dataMapper.getDocuments(t.toLowerCase()).has(e)?1:.5}removeDocument(e){this.trieSearch.remove(e),this.dataMapper.removeDocument(e)}addDocument(e,t,r){this.indexDocument(r,e,t)}updateDocument(e,t,r){this.removeDocument(t),this.indexDocument(e,t,r)}clear(){this.trieSearch=new o,this.dataMapper=new n}}function d(e,t){if(!e||!e.content||!Array.isArray(t))return{};const r={};for(const i of t)try{const t=l(e.content,i);void 0!==t&&(r[i]=h(t))}catch(e){console.warn(`Error processing field ${i}:`,e)}return r}function h(e){try{return null==e?"":"string"==typeof e?e.toLowerCase().trim():Array.isArray(e)?e.map((e=>h(e))).filter(Boolean).join(" "):"object"==typeof e?Object.values(e).map((e=>h(e))).filter(Boolean).join(" "):String(e).toLowerCase().trim()}catch(e){return console.warn("Error normalizing field value:",e),""}}function l(e,t){if(e&&t)try{const r=t.split(".");let i=e;for(const e of r){if(!i||"object"!=typeof i)return;if(Array.isArray(i)){const t=parseInt(e,10);if(isNaN(t))return;i=i[t]}else i=i[e]}return i}catch(e){return void console.warn(`Error getting nested value for path ${t}:`,e)}}function m(e){return Array.isArray(e)?e.map(m):null===e||"object"!=typeof e?e:Object.keys(e).sort().reduce(((t,r)=>(t[r]=m(e[r]),t)),{})}function u(e){if(!e.id||!e.content)return"";try{return`${e.id}:${Object.keys(e.content).sort().join(",")}`}catch(t){return e.id}}function f(e){if(e.maxResults&&e.maxResults<1)throw new Error("maxResults must be greater than 0");if(e.threshold&&(e.threshold<0||e.threshold>1))throw new Error("threshold must be between 0 and 1");if(e.fields&&!Array.isArray(e.fields))throw new Error("fields must be an array")}class p{getSize(){return this.documents.size}getAllDocuments(){return this.documents}constructor(e){this.config=e,this.indexMapper=new c,this.documents=new Map}async addDocuments(e){for(const[t,r]of e.entries()){const e=this.generateDocumentId(t),i={};for(const e of this.config.fields)e in r&&e in r&&(i[e]=r[e]);const s={id:e,content:d({content:i,id:e},this.config.fields),metadata:r.metadata};this.documents.set(e,{...r,id:e});try{await this.indexMapper.indexDocument(s,e,this.config.fields)}catch(t){console.warn(`Failed to index document ${e}:`,t)}}}async search(e,t={}){var r,i;if(!e.trim())return[];try{return(await this.indexMapper.search(e,{fuzzy:null!==(r=t.fuzzy)&&void 0!==r&&r,maxResults:null!==(i=t.maxResults)&&void 0!==i?i:10})).filter((e=>this.documents.has(e.item))).map((e=>{const t=this.documents.get(e.item);return{id:t.id,document:t,metadata:t.metadata,item:t,score:e.score,matches:e.matches}})).filter((e=>{var r;return e.score>=(null!==(r=t.threshold)&&void 0!==r?r:.5)}))}catch(e){return console.error("Search error:",e),[]}}exportIndex(){return{documents:Array.from(this.documents.entries()).map((([e,t])=>({key:e,value:this.serializeDocument(t)}))),indexState:this.indexMapper.exportState(),config:this.config}}importIndex(e){if(!this.isValidIndexData(e))throw new Error("Invalid index data format");try{const t=e;if(this.documents=new Map(t.documents.map((e=>[e.key,e.value]))),this.config=t.config,this.indexMapper=new c,!this.isValidIndexState(t.indexState))throw new Error("Invalid index state format");this.indexMapper.importState({trie:t.indexState.trie,dataMap:t.indexState.dataMap})}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to import index: ${t}`)}}async removeDocument(e){this.documents.has(e)&&(this.documents.delete(e),await this.indexMapper.removeDocument(e))}async updateDocument(e){const t=e.id;if(this.documents.has(t)){this.documents.set(t,e);const r={};for(const t of this.config.fields)t in e&&t in e&&(r[t]=e[t]);const i={id:t,content:d({content:r,id:t},this.config.fields),metadata:e.metadata};await this.indexMapper.updateDocument(i,t,this.config.fields)}}clear(){this.documents.clear(),this.indexMapper=new c}generateDocumentId(e){return`${this.config.name}-${e}-${Date.now()}`}isValidIndexData(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean(t.documents&&Array.isArray(t.documents)&&void 0!==t.indexState&&t.config&&"object"==typeof t.config)}isValidIndexState(e){return null!==e&&"object"==typeof e&&"trie"in e&&"dataMap"in e}serializeDocument(e){return JSON.parse(JSON.stringify(e))}}class g{constructor(){this.STOP_WORDS=new Set(["a","an","and","are","as","at","be","by","for","from","has","he","in","is","it","its","of","on","that","the","to","was","were","will","with"])}process(e){if(null==e)return"";if("string"!=typeof e)return String(e);const t=this.tokenize(e),r=this.processTokens(t);return this.optimizeQuery(r)}tokenize(e){return e.toLowerCase().split(/\s+/).filter((e=>e.length>0)).map((e=>this.classifyToken(e)))}classifyToken(e){return e.startsWith("+")||e.startsWith("-")?{type:"operator",value:e}:e.includes(":")?{type:"modifier",value:e}:{type:"term",value:e}}processTokens(e){return e.filter((e=>"term"!==e.type||!this.STOP_WORDS.has(e.value))).map((e=>this.normalizeToken(e)))}normalizeToken(e){if("term"===e.type){let t=e.value;return t.endsWith("ing")&&(t=t.slice(0,-3)),t.endsWith("ed")&&(t=t.slice(0,-2)),t.endsWith("s")&&!t.endsWith("ss")&&(t=t.slice(0,-1)),{...e,value:t}}return e}optimizeQuery(e){return e.map((e=>e.value)).join(" ")}}class w{constructor(e){this.isInitialized=!1,this.config=e,this.indexManager=new p(e),this.queryProcessor=new g,this.storage=new i(e.storage),this.cache=new r,this.eventListeners=new Set,this.trie=new o,this.documents=new Map,this.trieRoot={id:"",value:"",score:0,children:new Map}}async initialize(){if(!this.isInitialized)try{try{await this.storage.initialize()}catch(e){this.emitEvent({type:"storage:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),this.storage=new i({type:"memory"}),await this.storage.initialize()}await this.loadIndexes(),this.isInitialized=!0,this.emitEvent({type:"engine:initialized",timestamp:Date.now()})}catch(e){throw new Error(`Failed to initialize search engine: ${String(e)}`)}}async addDocuments(e){this.isInitialized||await this.initialize(),this.emitEvent({type:"index:start",timestamp:Date.now(),data:{documentCount:e.length}});try{for(const t of e){const e=t.id||this.generateDocumentId(),r=new s(e,t.fields,{...t.metadata,indexed:Date.now(),lastModified:Date.now()});this.documents.set(e,r);const i=d({content:r.fields,id:e},this.config.fields);for(const t of this.config.fields)if(i[t]){const r=i[t].toLowerCase().split(/\s+/).filter(Boolean);for(const t of r)this.trie.insert(t,e)}}await this.indexManager.addDocuments(e),await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex()),this.cache.clear(),this.emitEvent({type:"index:complete",timestamp:Date.now(),data:{documentCount:e.length}})}catch(e){throw this.emitEvent({type:"index:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to add documents: ${e}`)}}async search(e,t={}){this.isInitialized||await this.initialize(),f(t);const r=Date.now();this.emitEvent({type:"search:start",timestamp:r,data:{query:e,options:t}});const i=this.generateCacheKey(e,t),s=this.cache.get(i);if(s)return s;try{let s;if(t.regex){const e="string"==typeof t.regex?new RegExp(t.regex):t.regex;s=this.isComplexRegex(e)?function(e,t,r=10){const i=[],s=new Set;return function e(n,a){if(!(i.length>=r)){t.test(a)&&n.id&&!s.has(n.id)&&(i.push({id:n.id,score:n.score}),s.add(n.id));for(const[t,r]of n.children.entries())e(r,a+t)}}(e,""),i.sort(((e,t)=>t.score-e.score))}(this.trieRoot,e,t.maxResults||10):function(e,t,r=10){const i=[],s=[],n=new Set;for(s.push({node:e,matched:""});s.length>0&&i.length<r;){const{node:e,matched:r}=s.shift();t.test(r)&&e.id&&!n.has(e.id)&&(i.push({id:e.id,score:e.score}),n.add(e.id));for(const[t,i]of e.children.entries())s.push({node:i,matched:r+t})}return i.sort(((e,t)=>t.score-e.score))}(this.trieRoot,e,t.maxResults||10)}else{const r=this.queryProcessor.process(e).toLowerCase().split(/\s+/).filter(Boolean);s=await this.performBasicSearch(r,t)}const n=await this.processSearchResults(s,t);return this.cache.set(i,n),this.emitEvent({type:"search:complete",timestamp:Date.now(),data:{query:e,options:t,resultCount:n.length,searchTime:Date.now()-r}}),n}catch(e){throw this.emitEvent({type:"search:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Search failed: ${e}`)}}async updateDocument(e){this.isInitialized||await this.initialize();const t=e.id;if(!t||!this.documents.has(t))throw new Error(`Document ${t} not found`);try{await this.removeDocument(t),await this.addDocuments([e]),this.emitEvent({type:"update:complete",timestamp:Date.now(),data:{documentId:t}})}catch(e){throw this.emitEvent({type:"update:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to update document: ${e}`)}}async removeDocument(e){if(this.isInitialized||await this.initialize(),!this.documents.has(e))throw new Error(`Document ${e} not found`);try{this.documents.delete(e),this.trie.removeData(e),await this.indexManager.removeDocument(e),this.cache.clear();try{await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())}catch(e){this.emitEvent({type:"storage:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))})}this.emitEvent({type:"remove:complete",timestamp:Date.now(),data:{documentId:e}})}catch(e){throw this.emitEvent({type:"remove:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to remove document: ${e}`)}}async clearIndex(){this.isInitialized||await this.initialize();try{await this.storage.clearIndices(),this.documents.clear(),this.trie=new o,this.indexManager.clear(),this.cache.clear(),this.emitEvent({type:"index:clear",timestamp:Date.now()})}catch(e){throw this.emitEvent({type:"index:clear:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Failed to clear index: ${e}`)}}async performBasicSearch(e,t){const r=new Map;for(const i of e){const e=t.fuzzy?this.trie.fuzzySearch(i):this.trie.search(i);for(const s of e){const e=r.get(s)||{score:0,matches:new Set};e.score+=this.calculateTermScore(i,s,t),e.matches.add(i),r.set(s,e)}}return Array.from(r.entries()).map((([e,{score:t}])=>({id:e,score:t}))).sort(((e,t)=>t.score-e.score))}async processSearchResults(e,t){const r=[];for(const{id:i,score:s}of e){const e=this.documents.get(i);if(!e)continue;const n={id:i,item:e,score:this.normalizeScore(s),matches:[],metadata:{...e.metadata,lastAccessed:Date.now()},document:e};t.includeMatches&&(n.matches=this.extractMatches(e,t)),r.push(n)}return this.applyPagination(r,t)}calculateTermScore(e,t,r){var i;const s=this.documents.get(t);if(!s)return 0;const n=r.fields||this.config.fields;let a=0;for(const t of n){const n=String(s.fields[t]||"").toLowerCase(),o=(null===(i=r.boost)||void 0===i?void 0:i[t])||1;a+=(n.match(new RegExp(e,"gi"))||[]).length*o}return a}normalizeScore(e){return Math.min(Math.max(e/100,0),1)}extractMatches(e,t){const r=new Set,i=t.fields||this.config.fields;for(const s of i){const i=String(e.fields[s]||"").toLowerCase();if(t.regex){const e="string"==typeof t.regex?new RegExp(t.regex,"gi"):new RegExp(t.regex.source,"gi");(i.match(e)||[]).forEach((e=>r.add(e)))}}return Array.from(r)}applyPagination(e,t){const r=t.page||1,i=t.pageSize||10,s=(r-1)*i;return e.slice(s,s+i)}isComplexRegex(e){const t=e.source;return t.includes("{")||t.includes("+")||t.includes("*")||t.includes("?")||t.includes("|")||t.includes("(?")||t.includes("[")}async loadIndexes(){try{const e=await this.storage.getIndex(this.config.name);if(e){this.indexManager.importIndex(e);const t=this.indexManager.getAllDocuments();for(const e of t)this.documents.set(e[1].id,s.fromObject(e[1]))}}catch(e){console.warn("Failed to load stored index, starting fresh:",e)}}generateCacheKey(e,t){return`${this.config.name}-${e}-${JSON.stringify(t)}`}generateDocumentId(){return`${this.config.name}-${Date.now()}-${Math.random().toString(36).substring(2,15)}`}addEventListener(e){this.eventListeners.add(e)}removeEventListener(e){this.eventListeners.delete(e)}emitEvent(e){this.eventListeners.forEach((t=>{try{t(e)}catch(e){console.error("Error in event listener:",e)}}))}async close(){try{await this.storage.close(),this.cache.clear(),this.documents.clear(),this.isInitialized=!1,this.emitEvent({type:"engine:closed",timestamp:Date.now()})}catch(e){console.warn("Error during close:",e)}}getIndexedDocumentCount(){return this.documents.size}getTrieState(){return this.trie.exportState()}async bulkUpdate(e){this.isInitialized||await this.initialize();const t=[];for(const[r,i]of e){const e=this.documents.get(r);if(e){const n=new s(r,{...e.fields,...i.fields},{...e.metadata,...i.metadata});t.push(this.updateDocument(n))}}try{await Promise.all(t),this.emitEvent({type:"bulk:update:complete",timestamp:Date.now(),data:{updateCount:e.size}})}catch(e){throw this.emitEvent({type:"bulk:update:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Bulk update failed: ${e}`)}}async importIndex(e){this.isInitialized||await this.initialize();try{await this.clearIndex(),this.indexManager.importIndex(e);const t=Array.from(this.documents.values()).map((e=>s.fromObject(e)));await this.addDocuments(t),this.emitEvent({type:"import:complete",timestamp:Date.now(),data:{documentCount:this.documents.size}})}catch(e){throw this.emitEvent({type:"import:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Import failed: ${e}`)}}exportIndex(){if(!this.isInitialized)throw new Error("Search engine not initialized");return this.indexManager.exportIndex()}getDocument(e){return this.documents.get(e)}getAllDocuments(){return Array.from(this.documents.values())}async reindexAll(){this.isInitialized||await this.initialize();try{const e=this.getAllDocuments();await this.clearIndex(),await this.addDocuments(e),this.emitEvent({type:"reindex:complete",timestamp:Date.now(),data:{documentCount:e.length}})}catch(e){throw this.emitEvent({type:"reindex:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Reindex failed: ${e}`)}}async optimizeIndex(){this.isInitialized||await this.initialize();try{this.cache.clear(),this.storage instanceof i&&(await this.storage.clearIndices(),await this.storage.storeIndex(this.config.name,this.indexManager.exportIndex())),this.emitEvent({type:"optimize:complete",timestamp:Date.now()})}catch(e){throw this.emitEvent({type:"optimize:error",timestamp:Date.now(),error:e instanceof Error?e:new Error(String(e))}),new Error(`Optimization failed: ${e}`)}}getStats(){return{documentCount:this.documents.size,indexSize:this.indexManager.getSize(),cacheSize:this.cache.getSize(),initialized:this.isInitialized}}isReady(){return this.isInitialized}}class y extends Error{constructor(e){super(e),this.name="ValidationError"}}class x extends Error{constructor(e){super(e),this.name="StorageError"}}class S extends Error{constructor(e,t,r){super(e),this.type=t,this.details=r,this.name="SearchEventError"}}var v;e.CacheStrategyType=void 0,(v=e.CacheStrategyType||(e.CacheStrategyType={})).LRU="LRU",v.MRU="MRU";class E extends Error{constructor(e){super(e),this.name="SearchError"}}class z extends Error{constructor(e){super(e),this.name="IndexError"}}function D(e){if(!e||"object"!=typeof e)return!1;const t=e;return(void 0===t.fuzzy||"boolean"==typeof t.fuzzy)&&(void 0===t.maxResults||"number"==typeof t.maxResults)&&(void 0===t.threshold||"number"==typeof t.threshold)&&(void 0===t.fields||Array.isArray(t.fields))&&(void 0===t.sortBy||"string"==typeof t.sortBy)&&(void 0===t.sortOrder||["asc","desc"].includes(t.sortOrder))&&(void 0===t.page||"number"==typeof t.page)&&(void 0===t.pageSize||"number"==typeof t.pageSize)&&(void 0===t.regex||"string"==typeof t.regex||t.regex instanceof RegExp)&&(void 0===t.boost||"object"==typeof t.boost&&null!==t.boost)}function M(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean("string"==typeof t.name&&"number"==typeof t.version&&Array.isArray(t.fields))}function I(e){if(!e||"object"!=typeof e)return!1;const t=e;return Boolean("id"in t&&"item"in t&&"document"in t&&"number"==typeof t.score&&Array.isArray(t.matches))}const b={DEFAULT_INDEX_OPTIONS:{fields:[]},DEFAULT_SEARCH_OPTIONS:{fuzzy:!1,fields:[],boost:{},maxResults:10,threshold:.5,sortBy:"score",sortOrder:"desc",page:1,pageSize:10,regex:"",highlight:!1,includeMatches:!1,includeScore:!1,includeStats:!1},SearchError:E,IndexError:z,SearchEngine:w,IndexManager:p,QueryProcessor:g,TrieNode:a,TrieSearch:o,isSearchOptions:D,isIndexConfig:M,isSearchResult:I};"undefined"!=typeof window&&(window.NexusSearch=b);const O=b;e.CacheManager=r,e.DataMapper=n,e.IndexError=z,e.IndexManager=p,e.IndexMapper=c,e.IndexedDB=class{constructor(){this.db=null,this.DB_NAME="nexus_search_db",this.DB_VERSION=1,this.initPromise=null,this.initPromise=this.initialize()}async initialize(){if(!this.db)try{this.db=await t.openDB(this.DB_NAME,this.DB_VERSION,{upgrade(e){if(!e.objectStoreNames.contains("searchIndices")){e.createObjectStore("searchIndices",{keyPath:"id"}).createIndex("timestamp","timestamp")}if(!e.objectStoreNames.contains("metadata")){e.createObjectStore("metadata",{keyPath:"id"}).createIndex("lastUpdated","lastUpdated")}},blocked(){console.warn("Database upgrade was blocked")},blocking(){console.warn("Current database version is blocking a newer version")},terminated(){console.error("Database connection was terminated")}})}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Storage initialization failed: ${t}`)}}async ensureConnection(){if(this.initPromise&&await this.initPromise,!this.db)throw new Error("Database connection not available")}async storeIndex(e,t){await this.ensureConnection();try{const r={id:e,data:t,timestamp:Date.now()};await this.db.put("searchIndices",r)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to store index: ${t}`)}}async getIndex(e){var t;await this.ensureConnection();try{const r=await this.db.get("searchIndices",e);return null!==(t=null==r?void 0:r.data)&&void 0!==t?t:null}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to retrieve index: ${t}`)}}async updateMetadata(e){await this.ensureConnection();try{const t={id:"config",config:e,lastUpdated:Date.now()};await this.db.put("metadata",t)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to update metadata: ${t}`)}}async getMetadata(){await this.ensureConnection();try{const e=await this.db.get("metadata","config");return null!=e?e:null}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to retrieve metadata: ${t}`)}}async clearIndices(){await this.ensureConnection();try{await this.db.clear("searchIndices")}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to clear indices: ${t}`)}}async deleteIndex(e){await this.ensureConnection();try{await this.db.delete("searchIndices",e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to delete index: ${t}`)}}async close(){this.db&&(this.db.close(),this.db=null)}},e.NexusSearch=O,e.PerformanceMonitor=class{constructor(){this.metrics=new Map}async measure(e,t){const r=performance.now();try{return await t()}finally{const t=performance.now()-r;this.recordMetric(e,t)}}recordMetric(e,t){this.metrics.has(e)||this.metrics.set(e,[]),this.metrics.get(e).push(t)}getMetrics(){const e={};return this.metrics.forEach(((t,r)=>{e[r]={avg:this.average(t),min:Math.min(...t),max:Math.max(...t),count:t.length}})),e}average(e){return e.reduce(((e,t)=>e+t),0)/e.length}clear(){this.metrics.clear()}},e.QueryProcessor=g,e.SearchEngine=w,e.SearchError=E,e.SearchEventError=S,e.StorageError=x,e.TrieNode=a,e.TrieSearch=o,e.ValidationError=y,e.createSearchableFields=d,e.default=O,e.getNestedValue=l,e.isIndexConfig=M,e.isSearchOptions=D,e.isSearchResult=I,e.normalizeFieldValue=h,e.optimizeIndex=function(e){if(!Array.isArray(e))return{data:[],stats:{originalSize:0,optimizedSize:0,compressionRatio:1}};try{const t=new Map;for(const r of e){const e=JSON.stringify(m(r));t.set(e,r)}const r=Array.from(t.values()).sort(((e,t)=>{const r=u(e),i=u(t);return r.localeCompare(i)}));return{data:r,stats:{originalSize:e.length,optimizedSize:r.length,compressionRatio:e.length?r.length/e.length:1}}}catch(t){return console.warn("Error optimizing index:",t),{data:[...e],stats:{originalSize:e.length,optimizedSize:e.length,compressionRatio:1}}}},e.validateDocument=function(e,t){return t.every((t=>void 0!==l(e.content,t)))},e.validateIndexConfig=function(e){if(!e.name)throw new Error("Index name is required");if(!e.version||"number"!=typeof e.version)throw new Error("Valid version number is required");if(!Array.isArray(e.fields)||0===e.fields.length)throw new Error("At least one field must be specified for indexing")},e.validateSearchOptions=f,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
